<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø´Ø§Øª Ù†ÙˆÙ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <script src="https://unpkg.com/videojs-youtube/dist/Youtube.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      background: #0f0f0f;
    }
    
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: #0f0f0f;
      color: #ffffff;
      display: flex; 
      flex-direction: column; 
    }
    
    #chat-container { 
      display: flex; 
      flex-direction: column; 
      height: 100%; 
    }
    
    #messages { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      background: #0f0f0f;
      scroll-behavior: smooth; 
    }
    
    .msg { 
      margin: 8px 0; 
      display: flex; 
      gap: 8px; 
      align-items: flex-start; 
      direction: ltr; 
      text-align: left; 
      font-size: 15px; 
      line-height: 1.4; 
      position: relative;
    }
    
    .sys { 
      text-align: center; 
      color: #aaa;
      font-size: 12px; 
      margin: 10px auto; 
      font-style: italic; 
      background-color: #272727;
      padding: 4px 10px; 
      border-radius: 12px; 
      transition: opacity 0.5s; 
    }
    
    .user { 
      font-weight: bold; 
      color: #3ea6ff;
      min-width: 60px;
      flex-shrink: 0;
    }
    
    .message-content {
      flex: 1;
      word-break: break-word;
    }
    
    .message-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .message-time {
      font-size: 10px;
      color: #888;
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      white-space: nowrap;
    }
    
    .delete-btn { 
      background: none; 
      border: none; 
      color: #ff6b6b;
      font-size: 12px; 
      cursor: pointer; 
      opacity: 0.6; 
      padding: 4px;
      flex-shrink: 0;
    }
    
    .delete-btn:hover { 
      opacity: 1; 
      background-color: rgba(255, 107, 107, 0.1);
      border-radius: 4px; 
    }

    /* Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… */
    #pinnedVideoPlayer { 
      position: fixed; 
      top: 50px; 
      left: 50px; 
      width: clamp(320px, 90vw, 854px); 
      background: #000; 
      border-radius: 12px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.8); 
      z-index: 998; 
      display: none; 
      flex-direction: column; 
      overflow: hidden; 
      font-family: 'Tajawal', sans-serif;
    }
    
    .video-header { 
      background: #0f0f0f;
      color: #ffffff;
      padding: 12px 16px; 
      cursor: move; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-shrink: 0; 
      touch-action: none; 
      font-size: 14px; 
      border-bottom: 1px solid #272727;
    }
    
    .video-body { 
      width: 100%; 
      background: #000; 
      flex-grow: 1; 
      position: relative;
      min-height: 180px;
    }
    
    .video-js {
      width: 100%;
      height: 100%;
    }
    
    /* ØªØ­ÙƒÙ…Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø®ØµØµØ© - ØªØµÙ…ÙŠÙ… Ø£Ø¨ÙŠØ¶ */
    .youtube-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      padding: 0 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .video-body:hover .youtube-controls {
      opacity: 1;
    }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
    .progress-container {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.2);
      cursor: pointer;
      position: relative;
      margin-bottom: 4px;
    }
    
    .progress-bar {
      height: 100%;
      background: #ffffff;
      width: 0%;
      position: relative;
      transition: width 0.1s linear;
    }
    
    .progress-handle {
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: #ffffff;
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .progress-container:hover .progress-handle {
      opacity: 1;
    }
    
    .progress-container:hover .progress-bar {
      height: 6px;
    }
    
    /* Ø§Ù„ØªØ­ÙƒÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© - ØªØµÙ…ÙŠÙ… Ø£Ø¨ÙŠØ¶ */
    .controls-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    
    .controls-left, .controls-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-btn {
      background: none;
      border: none;
      color: #ffffff;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      position: relative;
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .control-btn.active {
      background: rgba(255,255,255,0.3);
    }
    
    .control-btn i {
      font-size: 18px;
    }
    
    .play-pause-btn {
      width: 36px;
      height: 36px;
      background: #ffffff;
      color: #000000;
    }
    
    .play-pause-btn:hover {
      background: #f0f0f0;
    }
    
    .play-pause-btn i {
      font-size: 16px;
    }
    
    /* Ø§Ù„ÙˆÙ‚Øª */
    .time-display {
      color: #ffffff;
      font-size: 13px;
      font-family: 'Roboto', sans-serif;
      min-width: 80px;
      text-align: center;
    }
    
    /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
    .settings-menu {
      position: relative;
    }
    
    .menu-content {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: #272727;
      border: 1px solid #303030;
      border-radius: 8px;
      padding: 8px 0;
      min-width: 200px;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .menu-content.show {
      display: block;
    }
    
    .menu-item {
      padding: 8px 16px;
      color: #ffffff;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    
    .menu-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .menu-item.active {
      color: #3ea6ff;
      background: rgba(62, 166, 255, 0.1);
    }
    
    .menu-item i {
      font-size: 12px;
    }

    /* Ù†Ø§ÙØ°Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª */
    .subtitle-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #272727;
      border: 1px solid #303030;
      border-radius: 12px;
      padding: 20px;
      z-index: 1005;
      display: none;
      min-width: 400px;
    }
    
    .subtitle-modal.show {
      display: block;
    }
    
    .subtitle-options {
      margin: 15px 0;
    }
    
    .subtitle-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s ease;
    }
    
    .subtitle-option:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .subtitle-option.active {
      background: rgba(62, 166, 255, 0.2);
      color: #3ea6ff;
    }

    /* Ø¨Ø§Ù‚ÙŠ Ø§Ù„CSS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
    #inputArea {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: #0f0f0f;
      border-top: 1px solid #272727;
    }

    #messageInput { 
      flex: 1; 
      font-size: 16px; 
      height: 45px;
      padding: 0 15px;
      border: 1px solid #303030;
      border-radius: 25px; 
      font-family: 'Tajawal', sans-serif; 
      background: #272727;
      color: #ffffff;
      box-sizing: border-box;
    }
    
    #messageInput:focus { 
      border-color: #3ea6ff;
      outline: none; 
    }
    
    #messageInput::placeholder {
      color: #888;
    }
    
    #sendBtn { 
      height: 45px;
      padding: 0 25px; 
      border: none; 
      border-radius: 25px; 
      background: #3ea6ff;
      color: white; 
      cursor: pointer; 
      font-family: 'Tajawal', sans-serif;
      display: flex; 
      align-items: center; 
      justify-content: center;
      box-sizing: border-box;
      font-weight: 500;
    }

    #sendBtn:hover { 
      background: #2d8ad9;
    }
    
    #topButtons { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      display: flex; 
      gap: 8px; 
      z-index: 1000; 
    }
    
    .btn { 
      padding: 6px 10px; 
      background: #272727;
      border: 1px solid #303030;
      border-radius: 20px; 
      cursor: pointer; 
      font-size: 16px; 
      line-height: 1; 
      display: flex; 
      align-items: center; 
      color: #ffffff;
    }
    
    .btn .count-text { 
      font-size: 14px; 
      margin-right: 4px; 
    }
    
    #onlineList { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      border: 1px solid #303030;
      background: #272727;
      padding: 8px 14px; 
      border-radius: 20px; 
      font-size: 14px; 
      cursor: pointer; 
      z-index: 1000; 
      display: flex; 
      align-items: center; 
      gap: 5px; 
      color: #ffffff;
    }
    
    #usersBox, #setVideoModal { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: #272727;
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.5); 
      z-index: 1003; 
      display: none; 
      color: #ffffff;
      border: 1px solid #303030;
      min-width: 300px;
    }
    
    #usersList { 
      max-height: 200px; 
      overflow-y: auto; 
    }
    
    .user-item { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 8px 4px; 
      border-bottom: 1px solid #303030;
      font-size: 14px; 
    }
    
    .status-indicator { 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
    }
    
    .status-green { background-color: #3ea6ff; } 
    .status-yellow { background-color: #ffd600; } 
    .status-gray { background-color: #606060; }

    #loginScreen { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(15, 15, 15, 0.98);
      display: flex; 
      justify-content: center; 
      align-items: center; 
      z-index: 10000; 
    }
    
    #loginBox { 
      background: #272727;
      padding: 30px; 
      border-radius: 12px; 
      text-align: center; 
      min-width: 320px; 
      color: #ffffff;
      border: 1px solid #303030;
    }
    
    #usernameInput { 
      width: 100%; 
      padding: 12px; 
      margin: 10px 0; 
      border: 1px solid #303030;
      border-radius: 8px; 
      font-size: 16px; 
      text-align: center; 
      box-sizing: border-box; 
      font-family: 'Tajawal', sans-serif;
      background: #0f0f0f;
      color: #ffffff;
    }
    
    #usernameInput::placeholder {
      color: #888;
    }
    
    #loginBtn { 
      background: #3ea6ff;
      color: white; 
      border: none; 
      padding: 12px 30px; 
      border-radius: 8px; 
      font-size: 16px; 
      cursor: pointer; 
      font-family: 'Tajawal', sans-serif; 
      margin-top: 10px; 
      font-weight: 500;
    }
    
    #loginBtn:hover {
      background: #2d8ad9;
    }
    
    #overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.7);
      z-index: 1001; 
      display: none; 
    }

    /* Ù†Ø§ÙØ°Ø© Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨Ø« */
    .streaming-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #272727;
      border: 1px solid #303030;
      border-radius: 12px;
      padding: 20px;
      z-index: 1004;
      display: none;
      min-width: 400px;
      max-width: 90vw;
    }
    
    .streaming-modal.show {
      display: block;
    }
    
    .streaming-platforms {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    
    .platform-btn {
      background: #3ea6ff;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      font-size: 14px;
      transition: background 0.2s ease;
    }
    
    .platform-btn:hover {
      background: #2d8ad9;
    }
    
    .stream-input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #303030;
      border-radius: 6px;
      background: #0f0f0f;
      color: white;
      font-family: 'Tajawal', sans-serif;
    }

    /* Ø¥Ø®ÙØ§Ø¡ ØªØ­ÙƒÙ…Ø§Øª video.js Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
    .video-js .vjs-control-bar {
      display: none !important;
    }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    
    #messages::-webkit-scrollbar-track {
      background: #0f0f0f;
    }
    
    #messages::-webkit-scrollbar-thumb {
      background: #303030;
      border-radius: 4px;
    }
    
    #messages::-webkit-scrollbar-thumb:hover {
      background: #404040;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      #pinnedVideoPlayer {
        top: 10px;
        left: 10px;
        right: 10px;
        width: auto;
      }
      
      .control-btn {
        width: 36px;
        height: 36px;
      }
      
      .control-btn i {
        font-size: 16px;
      }
      
      .message-actions {
        gap: 6px;
      }
      
      .message-time {
        font-size: 9px;
        padding: 1px 4px;
      }
      
      .streaming-modal,
      .subtitle-modal {
        min-width: 90vw;
        padding: 15px;
      }
    }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div id="loginBox">
      <h2>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
      <input type="text" id="usernameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©)" maxlength="15" autofocus>
      <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div id="chat-container" style="display: none;">
    <div id="topButtons">
      <div class="btn" id="setVideoBtn" title="ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ">ğŸ“º</div>
      <div class="btn" id="onlineListBtn" title="Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†">ğŸ‘¥ <span id="count" class="count-text">0</span></div>
      <div class="btn" id="streamingBtn" title="Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨Ø«">ğŸ“¡</div>
    </div>
    
    <div id="pinnedVideoPlayer"></div>
    
    <div id="setVideoModal">
      <h4>ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¬Ù…ÙŠØ¹</h4>
      <input type="text" id="videoUrlInput" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ ØªÙˆÙŠØªØ±ØŒ M3UØŒ Ø£Ùˆ MP4"/>
      <button id="submitVideoUrlBtn">ØªØ«Ø¨ÙŠØª</button>
    </div>
    
    <!-- Ù†Ø§ÙØ°Ø© Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨Ø« -->
    <div id="streamingModal" class="streaming-modal">
      <h4>ğŸ“¡ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h4>
      <div class="streaming-platforms">
        <button class="platform-btn" data-platform="youtube">YouTube Live</button>
        <button class="platform-btn" data-platform="twitch">Twitch</button>
        <button class="platform-btn" data-platform="m3u">M3U Playlist</button>
        <button class="platform-btn" data-platform="facebook">Facebook Live</button>
      </div>
      <input type="text" id="streamUrlInput" class="stream-input" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±..."/>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="submitStreamBtn" style="flex:1; background: #3ea6ff; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø«</button>
        <button id="closeStreamModal" style="background: #606060; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª -->
    <div id="subtitleModal" class="subtitle-modal">
      <h4>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª</h4>
      <div class="subtitle-options">
        <div class="subtitle-option" data-subtitle="none">
          <i class="fas fa-times"></i>
          <span>Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª</span>
        </div>
        <div class="subtitle-option" data-subtitle="ar">
          <i class="fas fa-language"></i>
          <span>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
        </div>
        <div class="subtitle-option" data-subtitle="en">
          <i class="fas fa-language"></i>
          <span>English</span>
        </div>
        <div class="subtitle-option" data-subtitle="upload">
          <i class="fas fa-upload"></i>
          <span>ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ØªØ±Ø¬Ù…Ø©</span>
        </div>
      </div>
      <input type="file" id="subtitleFile" accept=".srt,.vtt" style="display: none;" />
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="closeSubtitleModal" style="flex:1; background: #606060; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    
    <div id="usersBox">
      <h4>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</h4>
      <div id="usersList"></div>
    </div>
    
    <div id="overlay"></div>
    
    <div id="messages" role="list"></div>
    
    <form id="inputArea">
      <button type="submit" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" />
    </form>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyDttyEjbuC6gzHxuN0IR8yi_9fO-aFyW64",
      authDomain: "studio-4914109762-6a41f.firebaseapp.com",
      databaseURL: "https://studio-4914109762-6a41f-default-rtdb.firebaseio.com",
      projectId: "studio-4914109762-6a41f",
      storageBucket: "studio-4914109762-6a41f.firebasestorage.app",
      messagingSenderId: "134781295069",
      appId: "1:134781295069:web:3c020f46f8fbeaca24fe34"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let username = '';
    let userRef, messagesRef, onlineRef, pinnedVideoRef;
    let serverTimeOffset = 0;
    let videoPlayerInstance = null;
    let youtubeControls = null;
    let currentSubtitles = null;

    const loginScreen = document.getElementById('loginScreen');
    const usernameInput = document.getElementById('usernameInput');
    const loginBtn = document.getElementById('loginBtn');
    const chatContainer = document.getElementById('chat-container');
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const onlineListBtn = document.getElementById("onlineListBtn");
    const setVideoBtn = document.getElementById("setVideoBtn");
    const streamingBtn = document.getElementById("streamingBtn");
    const usersBox = document.getElementById("usersBox");
    const setVideoModal = document.getElementById("setVideoModal");
    const streamingModal = document.getElementById("streamingModal");
    const subtitleModal = document.getElementById("subtitleModal");
    const videoUrlInput = document.getElementById("videoUrlInput");
    const streamUrlInput = document.getElementById("streamUrlInput");
    const subtitleFile = document.getElementById("subtitleFile");
    const submitVideoUrlBtn = document.getElementById("submitVideoUrlBtn");
    const submitStreamBtn = document.getElementById("submitStreamBtn");
    const closeStreamModal = document.getElementById("closeStreamModal");
    const closeSubtitleModal = document.getElementById("closeSubtitleModal");
    const pinnedVideoPlayer = document.getElementById("pinnedVideoPlayer");
    const overlay = document.getElementById("overlay");

    function attemptLogin() {
        let inputName = usernameInput.value.trim();
        const invalidChars = /[.#$\[\]]/;
        if (invalidChars.test(inputName)) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©");
            return;
        }
        if (inputName.length < 2) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");
            return;
        }

        username = inputName;
        userRef = db.ref("online/" + username);
        messagesRef = db.ref("messages");
        onlineRef = db.ref("online");
        pinnedVideoRef = db.ref("pinned_video");
        
        startChat();
    }

    loginBtn.onclick = attemptLogin;
    usernameInput.onkeypress = (e) => { if (e.key === 'Enter') attemptLogin(); };

    function startChat() {
      loginScreen.style.display = 'none';
      chatContainer.style.display = 'flex';

      db.ref('.info/serverTimeOffset').on('value', snap => serverTimeOffset = snap.val() || 0);

      userRef.set({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      userRef.onDisconnect().remove();

      setInterval(() => {
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      }, 60000);

      setInterval(() => {
         const now = Date.now() + serverTimeOffset;
         onlineRef.once('value', snap => {
             snap.forEach(child => {
                 if (now - child.val().lastActive > 90000) child.ref.remove();
             });
         });
      }, 60000);

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
      onlineListBtn.onclick = (e) => { e.stopPropagation(); usersBox.style.display = 'block'; overlay.style.display = 'block'; };
      setVideoBtn.onclick = (e) => { e.stopPropagation(); setVideoModal.style.display = 'block'; overlay.style.display = 'block'; };
      streamingBtn.onclick = (e) => { e.stopPropagation(); streamingModal.classList.add('show'); overlay.style.display = 'block'; };
      closeStreamModal.onclick = closeAllModals;
      closeSubtitleModal.onclick = closeAllModals;
      overlay.onclick = closeAllModals;
      
      // Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨Ø«
      document.querySelectorAll('.platform-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const platform = e.target.dataset.platform;
          let placeholder = '';
          
          switch(platform) {
            case 'youtube':
              placeholder = 'https://www.youtube.com/watch?v=... Ø£Ùˆ https://youtu.be/...';
              break;
            case 'twitch':
              placeholder = 'https://www.twitch.tv/Ø§Ø³Ù…_Ø§Ù„Ù‚Ù†Ø§Ø©';
              break;
            case 'm3u':
              placeholder = 'https://example.com/playlist.m3u';
              break;
            case 'facebook':
              placeholder = 'https://www.facebook.com/watch/live/...';
              break;
          }
          
          streamUrlInput.placeholder = placeholder;
        });
      });

      submitStreamBtn.onclick = () => {
        const url = streamUrlInput.value.trim();
        if (!url) {
          alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø«");
          return;
        }
        
        let type = 'direct';
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
          type = 'youtube';
        } else if (url.includes('twitch.tv')) {
          type = 'twitch';
        } else if (url.includes('.m3u')) {
          type = 'm3u';
        } else if (url.includes('facebook.com')) {
          type = 'facebook';
        }
        
        pinnedVideoRef.set({ 
          type: type, 
          url: url, 
          setBy: username,
          isLive: true 
        });
        
        closeAllModals();
      };

      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª
      document.querySelectorAll('.subtitle-option').forEach(option => {
        option.addEventListener('click', (e) => {
          const subtitleType = option.dataset.subtitle;
          
          document.querySelectorAll('.subtitle-option').forEach(opt => {
            opt.classList.remove('active');
          });
          option.classList.add('active');
          
          if (subtitleType === 'upload') {
            subtitleFile.click();
          } else if (subtitleType === 'none') {
            removeSubtitles();
          } else {
            loadSubtitles(subtitleType);
          }
        });
      });

      subtitleFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          loadCustomSubtitle(file);
        }
      });
      
      document.getElementById("inputArea").onsubmit = (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;
        
        const now = new Date();
        const time = formatTime12HourShort(now);
        
        messagesRef.push({ user: username, text: text, time: time, timestamp: firebase.database.ServerValue.TIMESTAMP });
        messageInput.value = "";
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
        scrollToBottom();
      };

      messagesRef.limitToLast(100).on("child_added", snap => {
        addMessageToUI(snap.key, snap.val());
      });

      messagesRef.on("child_removed", snap => {
        const msgElement = document.getElementById(`msg-${snap.key}`);
        if (msgElement) {
            msgElement.style.opacity = '0';
            setTimeout(() => msgElement.remove(), 300);
        }
      });

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
      onlineRef.on("value", snap => {
        document.getElementById("count").textContent = snap.numChildren();
        renderUsersList(snap.val() || {});
      });

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      submitVideoUrlBtn.onclick = () => {
        const url = videoUrlInput.value.trim();
        if (!url) return;
        
        const youtubeId = getYoutubeVideoId(url);
        const tweetId = getTweetId(url);
        
        if (youtubeId) {
          pinnedVideoRef.set({ type: 'youtube', id: youtubeId, setBy: username });
        } else if (tweetId) {
          pinnedVideoRef.set({ type: 'twitter', id: tweetId, setBy: username });
        } else if (url.toLowerCase().includes('.m3u')) {
          pinnedVideoRef.set({ type: 'm3u', url: url, setBy: username });
        } else if (isDirectVideo(url)) {
          pinnedVideoRef.set({ type: 'direct', url: url, setBy: username });
        } else {
          alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….");
          return;
        }
        
        closeAllModals();
      };

      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø«Ø¨Øª
      pinnedVideoRef.on("value", async (snap) => {
        const data = snap.val();
        if (videoPlayerInstance) {
          videoPlayerInstance.dispose();
          videoPlayerInstance = null;
        }
        if (youtubeControls) {
          youtubeControls.remove();
          youtubeControls = null;
        }
        pinnedVideoPlayer.innerHTML = '';

        if (data) {
          pinnedVideoPlayer.style.display = 'flex';
          const header = document.createElement('div');
          header.className = 'video-header';
          header.innerHTML = `<span>ğŸ¬ ${data.setBy} ${data.isLive ? 'ğŸ”´ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±' : ''}</span>`;
          const closeBtn = document.createElement('button');
          closeBtn.className = 'close-pinned-video';
          closeBtn.innerHTML = '<i class="fas fa-times"></i>';
          closeBtn.onclick = () => pinnedVideoRef.remove();
          header.appendChild(closeBtn);
          const body = document.createElement('div');
          body.className = 'video-body';
          
          const resizeHandle = document.createElement('div');
          resizeHandle.className = 'resize-handle';
          
          pinnedVideoPlayer.appendChild(header);
          pinnedVideoPlayer.appendChild(body);
          pinnedVideoPlayer.appendChild(resizeHandle);
          
          makeDraggable(pinnedVideoPlayer, header);
          makeResizable(pinnedVideoPlayer, resizeHandle);

          let videoSource = null;
          let videoType = '';

          if (data.type === 'youtube') {
            if (data.id) {
              videoSource = `https://www.youtube.com/watch?v=${data.id}`;
            } else {
              videoSource = data.url;
            }
            videoType = 'video/youtube';
          } else if (data.type === 'm3u') {
            videoSource = data.url;
            videoType = 'application/x-mpegURL';
          } else if (data.type === 'direct') {
            videoSource = data.url;
            videoType = 'video/mp4';
          } else if (data.type === 'twitter') {
            try {
              const response = await fetch(`https://api.vxtwitter.com/i/status/${data.id}`);
              const tweetData = await response.json();
              if (tweetData.media_extended && tweetData.media_extended.length > 0) {
                videoSource = tweetData.media_extended[0].url;
                videoType = 'video/mp4';
              } else {
                body.innerHTML = `<p style="color:white;padding:10px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆ.</p>`;
              }
            } catch (error) {
              console.error("Error fetching Twitter video:", error);
              body.innerHTML = `<p style="color:white;padding:10px;">Ø­Ø¯Ø« Ø®Ø·Ø£.</p>`;
            }
          } else if (['twitch', 'facebook'].includes(data.type)) {
            videoSource = data.url;
            videoType = 'video/mp4';
          }

          if (videoSource) {
            const videoEl = document.createElement('video-js');
            videoEl.className = 'vjs-netflix-theme';
            body.appendChild(videoEl);

            let playerOptions = {
              autoplay: true,
              muted: true,
              controls: false,
              aspectRatio: '16:9',
              playsinline: true,
              techOrder: data.type === 'youtube' ? ['youtube'] : ['html5'],
              sources: [{ type: videoType, src: videoSource }],
              youtube: {
                iv_load_policy: 1,
                modestbranding: 1
              }
            };
            
            videoPlayerInstance = videojs(videoEl, playerOptions);
            
            videoPlayerInstance.ready(() => {
              createYouTubeControls(body, videoPlayerInstance);
            });
          }

          addNotification(`${data.setBy} ${data.isLive ? 'Ø¨Ø¯Ø£ Ø¨Ø«Ø§Ù‹ Ù…Ø¨Ø§Ø´Ø±Ø§Ù‹' : 'Ù‚Ø§Ù… Ø¨ØªØ´ØºÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ'}`);
        } else {
          pinnedVideoPlayer.style.display = 'none';
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª
    function loadSubtitles(lang) {
      if (!videoPlayerInstance) return;
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      removeSubtitles();
      
      // Ø¥Ù†Ø´Ø§Ø¡ ØªØ±Ø¬Ù…Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø³ØªØ£ØªÙŠ Ù…Ù† Ù…Ù„ÙØ§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©)
      const subtitleTexts = {
        ar: [
          { start: 0, end: 5, text: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…" },
          { start: 5, end: 10, text: "Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" },
          { start: 10, end: 15, text: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ø¯Ù‚Ø©" }
        ],
        en: [
          { start: 0, end: 5, text: "Welcome to the advanced player" },
          { start: 5, end: 10, text: "This is an example of English subtitles" },
          { start: 10, end: 15, text: "All buttons are now working accurately" }
        ]
      };
      
      if (subtitleTexts[lang]) {
        currentSubtitles = subtitleTexts[lang];
        startSubtitleDisplay();
      }
    }

    function loadCustomSubtitle(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const content = e.target.result;
          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù SRT Ø£Ùˆ VTT (Ù…Ø¨Ø³Ø·Ø© Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¹Ø±Ø¶)
          alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª: ${file.name}\n\nØ³ÙŠØªÙ… Ø¯Ø¹Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©`);
        } catch (error) {
          alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª');
        }
      };
      reader.readAsText(file);
    }

    function removeSubtitles() {
      currentSubtitles = null;
      // Ø¥Ø²Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      const existingSubs = document.querySelector('.subtitle-display');
      if (existingSubs) {
        existingSubs.remove();
      }
    }

    function startSubtitleDisplay() {
      if (!videoPlayerInstance || !currentSubtitles) return;
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø¹Ø±Ø¶ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª
      let subtitleDisplay = document.querySelector('.subtitle-display');
      if (!subtitleDisplay) {
        subtitleDisplay = document.createElement('div');
        subtitleDisplay.className = 'subtitle-display';
        subtitleDisplay.style.cssText = `
          position: absolute;
          bottom: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 10px 20px;
          border-radius: 8px;
          font-size: 16px;
          text-align: center;
          max-width: 80%;
          z-index: 9;
        `;
        document.querySelector('.video-body').appendChild(subtitleDisplay);
      }

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª
      videoPlayerInstance.on('timeupdate', () => {
        if (!currentSubtitles) return;
        
        const currentTime = videoPlayerInstance.currentTime();
        const currentSub = currentSubtitles.find(sub => 
          currentTime >= sub.start && currentTime <= sub.end
        );
        
        if (currentSub) {
          subtitleDisplay.textContent = currentSub.text;
          subtitleDisplay.style.display = 'block';
        } else {
          subtitleDisplay.style.display = 'none';
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªØ­ÙƒÙ…Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
    function createYouTubeControls(container, player) {
      youtubeControls = document.createElement('div');
      youtubeControls.className = 'youtube-controls';
      
      // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
      const progressContainer = document.createElement('div');
      progressContainer.className = 'progress-container';
      const progressBar = document.createElement('div');
      progressBar.className = 'progress-bar';
      const progressHandle = document.createElement('div');
      progressHandle.className = 'progress-handle';
      progressBar.appendChild(progressHandle);
      progressContainer.appendChild(progressBar);
      
      // Ø§Ù„ØªØ­ÙƒÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ©
      const controlsBottom = document.createElement('div');
      controlsBottom.className = 'controls-bottom';
      
      const controlsLeft = document.createElement('div');
      controlsLeft.className = 'controls-left';
      
      const controlsRight = document.createElement('div');
      controlsRight.className = 'controls-right';
      
      // Ø§Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ³Ø±Ù‰
      const playPauseBtn = createControlButton('play-pause-btn', 'fas fa-play', 'ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù');
      const rewind10Btn = createControlButton('control-btn', 'fas fa-backward', 'Ø±Ø¬ÙˆØ¹ 10 Ø«ÙˆØ§Ù†ÙŠ');
      const rewind30Btn = createControlButton('control-btn', 'fas fa-fast-backward', 'Ø±Ø¬ÙˆØ¹ 30 Ø«ÙˆØ§Ù†ÙŠ');
      const forward10Btn = createControlButton('control-btn', 'fas fa-forward', 'ØªÙ‚Ø¯ÙŠÙ… 10 Ø«ÙˆØ§Ù†ÙŠ');
      const forward30Btn = createControlButton('control-btn', 'fas fa-fast-forward', 'ØªÙ‚Ø¯ÙŠÙ… 30 Ø«Ø§Ù†ÙŠØ©');
      const timeDisplay = document.createElement('div');
      timeDisplay.className = 'time-display';
      timeDisplay.textContent = '0:00 / 0:00';
      
      // Ø§Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠÙ…Ù†Ù‰
      const volumeBtn = createControlButton('control-btn', 'fas fa-volume-high', 'Ø§Ù„ØµÙˆØª');
      const muteBtn = createControlButton('control-btn', 'fas fa-volume-mute', 'ÙƒØªÙ…', false);
      const repeatBtn = createControlButton('control-btn', 'fas fa-redo', 'ØªÙƒØ±Ø§Ø±');
      const subtitleBtn = createControlButton('control-btn', 'fas fa-closed-captioning', 'Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª');
      const settingsBtn = createControlButton('control-btn', 'fas fa-gear', 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
      const fullscreenBtn = createControlButton('control-btn', 'fas fa-expand', 'Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©');
      
      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      controlsLeft.appendChild(playPauseBtn);
      controlsLeft.appendChild(rewind30Btn);
      controlsLeft.appendChild(rewind10Btn);
      controlsLeft.appendChild(forward10Btn);
      controlsLeft.appendChild(forward30Btn);
      controlsLeft.appendChild(timeDisplay);
      
      controlsRight.appendChild(volumeBtn);
      controlsRight.appendChild(muteBtn);
      controlsRight.appendChild(repeatBtn);
      controlsRight.appendChild(subtitleBtn);
      controlsRight.appendChild(settingsBtn);
      controlsRight.appendChild(fullscreenBtn);
      
      controlsBottom.appendChild(controlsLeft);
      controlsBottom.appendChild(controlsRight);
      
      // ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
      youtubeControls.appendChild(progressContainer);
      youtubeControls.appendChild(controlsBottom);
      container.appendChild(youtubeControls);
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ event listeners Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
      setupAdvancedControlEvents(player, {
        playPauseBtn,
        rewind10Btn,
        rewind30Btn,
        forward10Btn,
        forward30Btn,
        volumeBtn,
        muteBtn,
        repeatBtn,
        subtitleBtn,
        settingsBtn,
        fullscreenBtn,
        progressContainer,
        progressBar,
        timeDisplay
      });
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
    function createControlButton(className, icon, title, visible = true) {
      const btn = document.createElement('button');
      btn.className = className;
      btn.innerHTML = `<i class="${icon}"></i>`;
      btn.title = title;
      if (!visible) btn.style.display = 'none';
      return btn;
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
    function setupAdvancedControlEvents(player, controls) {
      const {
        playPauseBtn,
        rewind10Btn,
        rewind30Btn,
        forward10Btn,
        forward30Btn,
        volumeBtn,
        muteBtn,
        repeatBtn,
        subtitleBtn,
        settingsBtn,
        fullscreenBtn,
        progressContainer,
        progressBar,
        timeDisplay
      } = controls;

      // Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´ØºÙ„
      let isPlaying = false;
      let isMuted = false;
      let isLooping = false;
      let currentVolume = 1;

      // ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù
      playPauseBtn.addEventListener('click', () => {
        if (player.paused()) {
          player.play();
          playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
          isPlaying = true;
        } else {
          player.pause();
          playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
          isPlaying = false;
        }
      });

      // Ø§Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆØ§Ù„ØªØ£Ø®ÙŠØ±
      rewind10Btn.addEventListener('click', () => skipTime(-10, player));
      rewind30Btn.addEventListener('click', () => skipTime(-30, player));
      forward10Btn.addEventListener('click', () => skipTime(10, player));
      forward30Btn.addEventListener('click', () => skipTime(30, player));

      // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª
      volumeBtn.addEventListener('click', () => {
        isMuted = true;
        player.muted(isMuted);
        volumeBtn.style.display = 'none';
        muteBtn.style.display = 'flex';
      });

      muteBtn.addEventListener('click', () => {
        isMuted = false;
        player.muted(isMuted);
        volumeBtn.style.display = 'flex';
        muteBtn.style.display = 'none';
      });

      // Ø§Ù„ØªÙƒØ±Ø§Ø±
      repeatBtn.addEventListener('click', () => {
        isLooping = !isLooping;
        player.loop(isLooping);
        repeatBtn.classList.toggle('active', isLooping);
      });

      // Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª
      subtitleBtn.addEventListener('click', () => {
        subtitleModal.classList.add('show');
        overlay.style.display = 'block';
      });

      // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
      let isSeeking = false;
      
      progressContainer.addEventListener('mousedown', (e) => {
        isSeeking = true;
        seekToPosition(e, player, progressBar);
      });
      
      progressContainer.addEventListener('mousemove', (e) => {
        if (isSeeking) {
          seekToPosition(e, player, progressBar);
        }
      });
      
      document.addEventListener('mouseup', () => {
        isSeeking = false;
      });

      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      player.on('timeupdate', () => {
        if (!isSeeking) {
          const currentTime = player.currentTime();
          const duration = player.duration();
          const percent = (currentTime / duration) * 100;
          progressBar.style.width = percent + '%';
          
          timeDisplay.textContent = `${formatVideoTime(currentTime)} / ${formatVideoTime(duration)}`;
        }
      });

      player.on('play', () => {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        isPlaying = true;
      });

      player.on('pause', () => {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        isPlaying = false;
      });

      // Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
      fullscreenBtn.addEventListener('click', () => {
        if (player.isFullscreen()) {
          player.exitFullscreen();
          fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        } else {
          player.requestFullscreen();
          fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        }
      });

      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
      const settingsMenu = createSettingsMenu();
      const settingsContainer = document.createElement('div');
      settingsContainer.className = 'settings-menu';
      settingsContainer.appendChild(settingsBtn);
      settingsContainer.appendChild(settingsMenu);
      document.querySelector('.controls-right').appendChild(settingsContainer);

      settingsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        settingsMenu.classList.toggle('show');
      });

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
      document.addEventListener('click', () => {
        settingsMenu.classList.remove('show');
      });

      settingsMenu.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    function createSettingsMenu() {
      const menu = document.createElement('div');
      menu.className = 'menu-content';
      
      const speeds = [
        { value: 0.5, label: '0.5x' },
        { value: 0.75, label: '0.75x' },
        { value: 1, label: 'Ø¹Ø§Ø¯ÙŠ' },
        { value: 1.25, label: '1.25x' },
        { value: 1.5, label: '1.5x' },
        { value: 2, label: '2x' }
      ];
      
      speeds.forEach(speed => {
        const option = document.createElement('div');
        option.className = 'menu-item speed-option';
        option.dataset.speed = speed.value;
        option.textContent = speed.label;
        if (speed.value === 1) option.classList.add('active');
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const speed = parseFloat(e.target.dataset.speed);
          videoPlayerInstance.playbackRate(speed);
          document.querySelectorAll('.speed-option').forEach(opt => opt.classList.remove('active'));
          e.target.classList.add('active');
        });
        menu.appendChild(option);
      });
      
      return menu;
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…/Ø§Ù„ØªØ£Ø®ÙŠØ±
    function skipTime(seconds, player) {
      const currentTime = player.currentTime();
      const newTime = Math.max(0, Math.min(player.duration(), currentTime + seconds));
      player.currentTime(newTime);
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…ÙˆØ¶Ø¹ ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    function seekToPosition(e, player, progressBar) {
      const rect = e.currentTarget.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      const newTime = player.duration() * percent;
      player.currentTime(newTime);
      progressBar.style.width = (percent * 100) + '%';
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆÙ‚Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    function formatVideoTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      
      const hours = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hours > 0) {
        return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      } else {
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ 12 Ø³Ø§Ø¹Ø© Ù…Ø®ØªØµØ±
    function formatTime12HourShort(date) {
      let hours = date.getHours();
      let minutes = date.getMinutes();
      const ampm = hours >= 12 ? 'Ù…' : 'Øµ';
      
      hours = hours % 12;
      hours = hours ? hours : 12;
      minutes = minutes < 10 ? '0' + minutes : minutes;
      
      return `${hours}:${minutes} ${ampm}`;
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    function addMessageToUI(key, { user, text, time, timestamp }) {
      const div = document.createElement("div");
      div.className = "msg";
      div.id = `msg-${key}`;
      
      const isMe = user === username;
      
      const userSpan = document.createElement("span");
      userSpan.className = "user";
      userSpan.textContent = escapeHtml(user);
      
      const messageContent = document.createElement("div");
      messageContent.className = "message-content";
      messageContent.textContent = escapeHtml(text);
      
      const messageActions = document.createElement("div");
      messageActions.className = "message-actions";
      
      const timeSpan = document.createElement("span");
      timeSpan.className = "message-time";
      timeSpan.textContent = time;
      messageActions.appendChild(timeSpan);
      
      if (isMe) {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.onclick = () => {
          if(confirm("Ø­Ø°ÙØŸ")) messagesRef.child(key).remove();
        };
        messageActions.appendChild(deleteBtn);
      }
      
      div.appendChild(userSpan);
      div.appendChild(messageContent);
      div.appendChild(messageActions);

      messagesDiv.appendChild(div);
      scrollToBottom();
    }

    function addNotification(text) {
      const div = document.createElement("div");
      div.className = "sys";
      div.textContent = text;
      messagesDiv.appendChild(div);
      scrollToBottom();
    }

    function renderUsersList(users) {
        const list = document.getElementById("usersList");
        list.innerHTML = '';
        const now = Date.now() + serverTimeOffset;
        Object.keys(users).forEach(uName => {
            const uData = users[uName];
            const div = document.createElement("div");
            div.className = "user-item";
            let colorClass = 'status-green';
            const diff = now - (uData.lastActive || 0);
            if (diff > 60000) colorClass = 'status-gray';
            else if (diff > 30000) colorClass = 'status-yellow';
            div.innerHTML = `<span class="status-indicator ${colorClass}"></span><span>${escapeHtml(uName)}</span>`;
            list.appendChild(div);
        });
    }

    function closeAllModals() {
      usersBox.style.display = 'none';
      setVideoModal.style.display = 'none';
      streamingModal.classList.remove('show');
      subtitleModal.classList.remove('show');
      overlay.style.display = 'none';
    }

    function makeDraggable(element, handle) {
      let offsetX = 0, offsetY = 0;
      let isDragging = false;
      
      const getPointerPosition = (e) => e.touches ? e.touches[0] : e;
      
      const onDragStart = (e) => {
        isDragging = true;
        const pointer = getPointerPosition(e);
        offsetX = pointer.clientX - element.offsetLeft;
        offsetY = pointer.clientY - element.offsetTop;
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchend', onDragEnd);
      };
      
      const onDragMove = (e) => {
        if (isDragging) {
          e.preventDefault();
          const pointer = getPointerPosition(e);
          element.style.left = (pointer.clientX - offsetX) + "px";
          element.style.top = (pointer.clientY - offsetY) + "px";
        }
      };
      
      const onDragEnd = () => {
        isDragging = false;
        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchend', onDragEnd);
      };
      
      handle.addEventListener('mousedown', onDragStart);
      handle.addEventListener('touchstart', onDragStart, { passive: false });
    }

    function makeResizable(element, handle) {
      let initialWidth, initialHeight, initialX, initialY;
      const getPointerPosition = (e) => e.touches ? e.touches[0] : e;

      function onResizeStart(e) {
        if(e.type === 'touchstart') e.preventDefault();
        const pointer = getPointerPosition(e);
        initialWidth = element.offsetWidth;
        initialHeight = element.offsetHeight;
        initialX = pointer.clientX;
        initialY = pointer.clientY;
        document.addEventListener('mousemove', onResizeMove);
        document.addEventListener('touchmove', onResizeMove, { passive: false });
        document.addEventListener('mouseup', onResizeEnd);
        document.addEventListener('touchend', onResizeEnd);
      }

      function onResizeMove(e) {
        if(e.type === 'touchmove') e.preventDefault();
        const pointer = getPointerPosition(e);
        const newWidth = initialWidth + (pointer.clientX - initialX);
        const newHeight = initialHeight + (pointer.clientY - initialY);
        if (newWidth > 300) { element.style.width = newWidth + 'px'; }
        if (newHeight > 200) { element.style.height = newHeight + 'px'; }
      }

      function onResizeEnd() {
        document.removeEventListener('mousemove', onResizeMove);
        document.removeEventListener('touchmove', onResizeMove);
        document.removeEventListener('mouseup', onResizeEnd);
        document.removeEventListener('touchend', onResizeEnd);
      }
      
      handle.addEventListener('mousedown', onResizeStart);
      handle.addEventListener('touchstart', onResizeStart, { passive: false });
    }

    function getYoutubeVideoId(url) {
      if (!url) return null;
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      return (url.match(regex) || [])[1] || null;
    }

    function getTweetId(url) {
      if (!url) return null;
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:twitter|x)\.com\/(?:\w+)\/status\/(\d+)/;
      return (url.match(regex) || [])[1] || null;
    }

    function isDirectVideo(url) {
      return /\.(mp4|webm|ogv)$/.test(url);
    }

    function scrollToBottom() { messagesDiv.scrollTop = messagesDiv.scrollHeight; }
    function escapeHtml(unsafe) { if(!unsafe) return ""; return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
  });
</script>
</body>
</html>

