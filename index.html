<!DOCTYPE html>
<html lang="ar" hreflang="ar-sa" style="height: 100%;">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <title>Ø´Ø§Øª Ù†ÙˆÙ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Video.js CSS -->
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css">
  <style>
    body { margin: 0;  font-family: serif;
    font-size: 15.2px !important;
    font-weight: 700 !important;
    line-height: 1.4 !important;
    text-shadow: none !important;
    /* -------------------------- */

    overflow: hidden; 
    background-color: #f0f2f5; 
}
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; z-index: 2000; direction: rtl; }
    #loginBox { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 100%; max-width: 400px; }
    .nav-tabs { display: flex; list-style: none; padding: 0; margin: 0; border-bottom: 1px solid #ddd; }
    .nav-tabs li { flex: 1; text-align: center; }
    .nav-tabs li a { display: block; padding: 12px 6px; text-decoration: none; color: #555; background-color: #f7f7f7; border: 1px solid transparent; border-bottom: none; }
    .nav-tabs li.active a { background-color: #fff; border-color: #ddd; border-bottom-color: transparent; border-top-left-radius: 8px; border-top-right-radius: 8px; position: relative; top: 1px; }
    .tab-content { padding: 25px; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .form-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
    .form-submit-btn { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; color: #333; font-size: 16px; cursor: pointer; background-color: #f0f0f0; transition: background-color 0.2s; font-weight: bold; }
    .form-submit-btn:hover { background-color: #e0e0e0; }
    #error-message { color: #fa3e3e; margin-top: 15px; font-size: 14px; height: 20px; text-align: center; }
    #chatContainer { display: none; height: 100vh; position: relative; }
    #topButtons { position: fixed; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000; }
    .btn { padding: 6px 10px; background: white; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; font-size: 16px; line-height: 1; display: flex; align-items: center; }
    .btn .count-text { font-size: 14px; margin-right: 4px; }
    #usersBox, #editNameModal, #setVideoModal, #settingsModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1003; display: none; }
    #usersList { max-height: 200px; overflow-y: auto; }
    #settingsModal { width: 250px; }
    .settings-menu { list-style: none; padding: 0; margin: 0; }
    .settings-menu li { margin-bottom: 10px; }
    .settings-menu button { width: 100%; padding: 12px; text-align: right; font-size: 15px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .settings-menu button:hover { background-color: #e9e9e9; }
    .settings-menu button.logout { color: #d9534f; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; }
    #pinnedVideoPlayer { position: fixed; top: 50px; left: 50px; width: clamp(300px, 90vw, 480px); background: #000; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 998; display: none; flex-direction: column; overflow: hidden; }
    .video-header { background-color: #333; color: white; padding: 5px 10px; border-top-left-radius: 7px; border-top-right-radius: 7px; cursor: move; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; touch-action: none; font-size: 14px; }
    .video-body { width: 100%; background: #000; flex-grow: 1; }
    .video-js .vjs-tech { object-fit: contain; }
    .close-pinned-video { background: #d9534f; border: 1px solid #d43f3a; color: white; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 14px; line-height: 20px; text-align: center; }
    .resize-handle { position: absolute; width: 20px; height: 20px; bottom: 0; right: 0; cursor: nwse-resize; z-index: 10; }
    #inputArea { position: fixed; bottom: 0; left: 0; right: 0; display: flex; align-items: center; gap: 8px; border-top: 1px solid #ddd; padding: 6px; background: #fafafa; z-index: 999; }
    #messageInput { flex: 1; font-size: 16px; padding: 8px; border: 1px solid #ccc; outline: none; direction: ltr; }
    #sendBtn { padding: 8px 12px; background: #f0f0f0; border: 1px solid #ccc; cursor: pointer; }
    .user-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .status-active { background-color: #28a745; }
    .status-idle { background-color: #ffc107; }
    .user-list-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    #messages { overflow-y: auto; padding: 0; padding-bottom: 70px; background: #fff; direction: ltr; font-family: 'Tajawal', sans-serif; height: 100vh; box-sizing: border-box; }
    .hmsg { display: flex; outline: 1px solid lavender; width: 100%; }
    .u-pic { max-height: 52px !important; min-width: 52px; width: 52px; object-fit: cover; }
    .msg-content-fill { flex: 1; overflow: hidden; padding: 1px 1px 0 1px; }
    .msg-header { width: 100%; display: flex; height: 21px; align-items: center; justify-content: space-between; }
    .user-info-wrapper { display: flex; flex-grow: 1; overflow: hidden; }
    .u-topic {
    padding: 0;  
    display: block;
    border-radius: 2px;
    background-color: transparent; 
    color: #000;
    font-weight: bold;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}
    .tago { padding: 0px 2px; margin-left: 4px; color: grey; font-size: 11px; white-space: nowrap; }
    .u-msg { padding: 2px 1px 2px 5px; width: 100%; word-wrap: break-word; font-size: 15px; }
    .hmsg.notification { background-color: #f2f2f2; }
    .u-topic, .u-msg {
margin: 0;  font-family: serif;
    font-size: 15.2px !important;
}
    /* --- Netflix Theme for Video.js --- */
    .video-js.vjs-netflix-theme { background-color: #000; }
    .vjs-netflix-theme .vjs-control-bar { height: 6em; background: none; background-image: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%); }
    .vjs-netflix-theme .vjs-big-play-button { display: none !important; }
    .vjs-netflix-theme .vjs-progress-control { position: absolute; left: 0; right: 0; width: 100%; top: -3em; height: 2.5em; }
    .vjs-netflix-theme .vjs-progress-holder { height: 0.3em; margin: 1.1em 0; }
    .vjs-netflix-theme .vjs-play-progress, .vjs-netflix-theme .vjs-load-progress { height: 100%; }
    .vjs-netflix-theme .vjs-play-progress:before { display: none; }
    .vjs-netflix-theme .vjs-play-progress { background-color: #e50914; }
    .vjs-netflix-theme .vjs-load-progress { background: rgba(255, 255, 255, 0.4); }
    .vjs-netflix-theme .vjs-time-control { line-height: 5em; padding: 0 1em; }
    .vjs-netflix-theme .vjs-remaining-time { line-height: 5em; }
    .vjs-netflix-theme .vjs-button > .vjs-icon-placeholder:before { font-size: 2.2em; line-height: 2.2; }
    .vjs-netflix-theme .vjs-volume-panel, .vjs-netflix-theme .vjs-fullscreen-control { margin-right: 1em; }
    .video-js.vjs-netflix-theme.vjs-has-started.vjs-user-inactive .vjs-control-bar { opacity: 0; visibility: hidden; }
  </style>
</head>
<body>
    <div id="loginOverlay">
        <div id="loginBox">
            <ul class="nav-tabs">
                <li class="active"><a data-toggle="tab" href="#l1"><i class="fa fa-user"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²ÙˆØ§Ø±</a></li>
                <li><a data-toggle="tab" href="#l2"><i class="fa fa-user"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡</a></li>
                <li><a data-toggle="tab" href="#l3"><i class="fa fa-user-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶ÙˆÙŠÙ‡</a></li>
            </ul>
            <div class="tab-content">
                <div id="l1" class="tab-pane active">
                    <input type="text" id="visitorName" class="form-input" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±" required>
                    <button id="visitorBtn" class="form-submit-btn">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</button>
                </div>
                <div id="l2" class="tab-pane"><input type="text" id="loginName" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù…" required><input type="password" id="loginPassword" class="form-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required><button id="loginBtn" class="form-submit-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button></div>
                <div id="l3" class="tab-pane"><input type="text" id="registerName" class="form-input" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹" required><input type="password" id="registerPassword" class="form-input" placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" required><button id="registerBtn" class="form-submit-btn">ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button></div>
            </div>
            <div id="error-message"></div>
        </div>
    </div>
    <div id="chatContainer">
        <div id="topButtons">
            <div class="btn" id="setVideoBtn" title="ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ">ğŸ“º</div>
            <div class="btn" id="onlineListBtn" title="Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†">ğŸ‘¥ <span id="count" class="count-text">0</span></div>
            <div class="btn" id="settingsBtn" title="Ø§Ù„Ø¶Ø¨Ø·">âš™ï¸</div>
        </div>
        <div id="pinnedVideoPlayer"></div>
        <div id="setVideoModal"><h4>ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¬Ù…ÙŠØ¹</h4><input type="text" id="videoUrlInput" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ ØªÙˆÙŠØªØ±ØŒ M3UØŒ Ø£Ùˆ MP4"/><button id="submitVideoUrlBtn">ØªØ«Ø¨ÙŠØª</button></div>
        <div id="usersBox"><h4>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</h4><div id="usersList"></div></div>
        <div id="editNameModal"><label for="newNameInput">ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label><input type="text" id="newNameInput" maxlength="20" /><button id="saveNameBtn">Ø­ÙØ¸</button></div>
        <div id="settingsModal">
            <h4>Ø§Ù„Ø¶Ø¨Ø·</h4>
            <ul class="settings-menu">
                <li><button id="settingsChangeAvatarBtn"><i class="fa fa-picture-o"></i> ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button></li>
                <li><button id="settingsChangeNameBtn"><i class="fa fa-pencil"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button></li>
                <li><button id="logoutBtn" class="logout"><i class="fa fa-sign-out"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></li>
            </ul>
        </div>
        <div id="overlay"></div><div id="messages"></div>
        <div id="inputArea"><input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." /><button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button></div>
        <input type="file" id="avatarInput" accept="image/*" style="display: none;" />
    </div>

  <!-- Video.js Scripts -->
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <script src="https://unpkg.com/videojs-youtube/dist/Youtube.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDttyEjbuC6gzHxuN0IR8yi_9fO-aFyW64",
      authDomain: "studio-4914109762-6a41f.firebaseapp.com",
      projectId: "studio-4914109762-6a41f",
      storageBucket: "studio-4914109762-6a41f.firebasestorage.app",
      messagingSenderId: "134781295069",
      appId: "1:134781295069:web:3c020f46f8fbeaca24fe34"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.database();
    const loginOverlay = document.getElementById('loginOverlay'); const chatContainer = document.getElementById('chatContainer'); const errorMessage = document.getElementById('error-message');
    const tabs = document.querySelectorAll('.nav-tabs a'); const tabPanes = document.querySelectorAll('.tab-pane');
    tabs.forEach(tab => { tab.addEventListener('click', (e) => { e.preventDefault(); tabs.forEach(item => item.parentElement.classList.remove('active')); tab.parentElement.classList.add('active'); tabPanes.forEach(pane => pane.classList.remove('active')); document.querySelector(tab.getAttribute('href')).classList.add('active'); errorMessage.textContent = ''; }); });
    const registerBtn = document.getElementById('registerBtn'); const loginBtn = document.getElementById('loginBtn'); const visitorBtn = document.getElementById('visitorBtn');
    const createFakeEmail = (name) => `${name.toLowerCase().trim().replace(/\s+/g, '_')}@chat.local`;
    registerBtn.onclick = () => { const name = document.getElementById('registerName').value; const password = document.getElementById('registerPassword').value; if (!name || !password) { errorMessage.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; return; } const email = createFakeEmail(name); errorMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...'; auth.createUserWithEmailAndPassword(email, password).catch(error => { if (error.code === 'auth/email-already-in-use') { errorMessage.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.'; } else if (error.code === 'auth/weak-password') { errorMessage.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'; } else { errorMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.'; } }); };
    loginBtn.onclick = () => { const name = document.getElementById('loginName').value; const password = document.getElementById('loginPassword').value; if (!name || !password) { errorMessage.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; return; } const email = createFakeEmail(name); errorMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...'; auth.signInWithEmailAndPassword(email, password).catch(error => errorMessage.textContent = 'Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); };
    visitorBtn.onclick = () => { const visitorName = document.getElementById('visitorName').value.trim(); if (!visitorName) { errorMessage.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±.'; return; } errorMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±...'; auth.signInAnonymously().catch(error => errorMessage.textContent = error.message); };

    let chatInitialized = false; let heartbeatInterval = null;
    auth.onAuthStateChanged(user => {
        if (user) {
            loginOverlay.style.display = 'none'; chatContainer.style.display = 'block';
            if (!chatInitialized) { initializeApp(user); chatInitialized = true; }
        } else {
            loginOverlay.style.display = 'flex'; chatContainer.style.display = 'none';
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            chatInitialized = false;
        }
    });

    function initializeApp(user) {
        const myUserRef = db.ref("online").push();
        const myUserId = myUserRef.key;
        myUserRef.onDisconnect().remove();
        const defaultAvatarUrl = "https://j.top4top.io/p_3599hmcgu1.png";
        let myAvatarUrl = localStorage.getItem('userAvatar') || defaultAvatarUrl;
        if (!localStorage.getItem('userAvatar')) { localStorage.setItem('userAvatar', defaultAvatarUrl); }
        let username;
        if (user.isAnonymous) {
            const visitorNameInput = document.getElementById('visitorName').value.trim();
            if (visitorNameInput) { username = visitorNameInput; localStorage.setItem('visitorName', username); } 
            else { let savedVisitorName = localStorage.getItem('visitorName');
                if (savedVisitorName) { username = savedVisitorName; } 
                else { username = "Ø²Ø§Ø¦Ø±_" + Math.floor(Math.random() * 1000); localStorage.setItem('visitorName', username); }
            }
        } else { username = user.email.split('@')[0].replace(/_/g, ' '); }
        myUserRef.set({ name: username, status: 'active', avatar: myAvatarUrl, last_seen: firebase.database.ServerValue.TIMESTAMP });
        
        heartbeatInterval = setInterval(() => { 
            myUserRef.update({ last_seen: firebase.database.ServerValue.TIMESTAMP }); 
        }, 25 * 1000);

        const onlineListBtn = document.getElementById("onlineListBtn"); const setVideoBtn = document.getElementById("setVideoBtn"); const settingsBtn = document.getElementById("settingsBtn"); const settingsModal = document.getElementById("settingsModal"); const settingsChangeAvatarBtn = document.getElementById("settingsChangeAvatarBtn"); const settingsChangeNameBtn = document.getElementById("settingsChangeNameBtn"); const logoutBtn = document.getElementById("logoutBtn"); const avatarInput = document.getElementById("avatarInput"); const usersBox = document.getElementById("usersBox"); const usersList = document.getElementById("usersList"); const overlay = document.getElementById("overlay"); const count = document.getElementById("count"); const messagesDiv = document.getElementById("messages"); const messageInput = document.getElementById("messageInput"); const sendBtn = document.getElementById("sendBtn"); const editNameModal = document.getElementById("editNameModal"); const newNameInput = document.getElementById("newNameInput"); const saveNameBtn = document.getElementById("saveNameBtn"); const setVideoModal = document.getElementById("setVideoModal"); const videoUrlInput = document.getElementById("videoUrlInput"); const submitVideoUrlBtn = document.getElementById("submitVideoUrlBtn"); const pinnedVideoPlayer = document.getElementById("pinnedVideoPlayer");
        let onlineUsersCache = {}; let idleTimer; const IDLE_TIMEOUT = 2 * 60 * 1000;
        let initialUsersLoaded = false; 
        let videoPlayerInstance = null;

        function loadInitialMessages() {
            messagesDiv.innerHTML = '';
            db.ref("messages").limitToLast(30).on("child_added", (snap) => { 
                const msg = snap.val(); 
                addMessage(msg.user, msg.text, msg.time, msg.avatar); 
            });
        }

        function addMessage(user, text, time, avatarUrl) {
            const div = document.createElement("div"); div.className = "hmsg";
            const effectiveAvatar = avatarUrl || defaultAvatarUrl;
            div.innerHTML = `<img class="u-pic" src="${effectiveAvatar}"><div class="msg-content-fill"><div class="msg-header"><div class="user-info-wrapper"><span class="u-topic">${user}</span></div><span class="tago">(${time})</span></div><div class="u-msg">${text}</div></div>`;
            messagesDiv.appendChild(div); messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addNotification(user, text, avatarUrl) {
            const div = document.createElement("div"); div.className = "hmsg notification";
            const effectiveAvatar = avatarUrl || defaultAvatarUrl;
            const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
            div.innerHTML = `<img class="u-pic" src="${effectiveAvatar}"><div class="msg-content-fill"><div class="msg-header"><div class="user-info-wrapper"><span class="u-topic">${user}</span></div><span class="tago">(${time})</span></div><div class="u-msg">${text}</div></div>`;
            messagesDiv.appendChild(div); messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function closeAllModals() { usersBox.style.display = 'none'; editNameModal.style.display = 'none'; setVideoModal.style.display = 'none'; settingsModal.style.display = 'none'; overlay.style.display = 'none'; }
        
        onlineListBtn.onclick = () => { usersBox.style.display = 'block'; overlay.style.display = 'block'; };
        setVideoBtn.onclick = () => { setVideoModal.style.display = 'block'; overlay.style.display = 'block'; };
        settingsBtn.onclick = () => { settingsModal.style.display = 'block'; overlay.style.display = 'block'; };
        settingsChangeNameBtn.onclick = () => { closeAllModals(); editNameModal.style.display = 'block'; overlay.style.display = 'block'; newNameInput.value = username; newNameInput.focus(); };
        settingsChangeAvatarBtn.onclick = () => { avatarInput.click(); closeAllModals(); };
        logoutBtn.onclick = () => { closeAllModals(); myUserRef.remove(); auth.signOut(); };
        overlay.onclick = closeAllModals;
        sendBtn.onclick = sendMessage;
        messageInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
        saveNameBtn.onclick = () => { const newName = newNameInput.value.trim(); if (!newName) return; updateUsername(newName); closeAllModals(); };
        avatarInput.onchange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = () => { const base64String = reader.result; myAvatarUrl = base64String; localStorage.setItem('userAvatar', base64String); myUserRef.update({ avatar: base64String }); addNotification(username, "âœ… ØªÙ… ØªØºÙŠÙŠØ± ØµÙˆØ±ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­.", myAvatarUrl); }; reader.readAsDataURL(file); };
        
        function updateMyStatus(newStatus) { myUserRef.child('status').once('value', (snapshot) => { if (snapshot.val() !== newStatus) { myUserRef.update({ status: newStatus }); } }); }
        function resetIdleTimer() { clearTimeout(idleTimer); updateMyStatus('active'); idleTimer = setTimeout(() => { updateMyStatus('idle'); }, IDLE_TIMEOUT); }
        document.addEventListener('mousemove', resetIdleTimer); document.addEventListener('keypress', resetIdleTimer); messageInput.addEventListener('input', resetIdleTimer); resetIdleTimer();
        function makeDraggable(element, handle) { let offsetX = 0, offsetY = 0; let isDragging = false; const getPointerPosition = (e) => e.touches ? e.touches[0] : e; const onDragStart = (e) => { isDragging = true; const pointer = getPointerPosition(e); offsetX = pointer.clientX - element.offsetLeft; offsetY = pointer.clientY - element.offsetTop; document.addEventListener('mousemove', onDragMove); document.addEventListener('touchmove', onDragMove, { passive: false }); document.addEventListener('mouseup', onDragEnd); document.addEventListener('touchend', onDragEnd); }; const onDragMove = (e) => { if (isDragging) { e.preventDefault(); const pointer = getPointerPosition(e); element.style.left = (pointer.clientX - offsetX) + "px"; element.style.top = (pointer.clientY - offsetY) + "px"; } }; const onDragEnd = () => { isDragging = false; document.removeEventListener('mousemove', onDragMove); document.removeEventListener('touchmove', onDragMove); document.removeEventListener('mouseup', onDragEnd); document.removeEventListener('touchend', onDragEnd); }; handle.addEventListener('mousedown', onDragStart); handle.addEventListener('touchstart', onDragStart, { passive: false }); }
        
        function makeResizable(element, handle) {
            let initialWidth, initialHeight, initialX, initialY;
            const getPointerPosition = (e) => e.touches ? e.touches[0] : e;
            function onResizeStart(e) { if(e.type === 'touchstart') e.preventDefault(); const pointer = getPointerPosition(e); initialWidth = element.offsetWidth; initialHeight = element.offsetHeight; initialX = pointer.clientX; initialY = pointer.clientY; document.addEventListener('mousemove', onResizeMove); document.addEventListener('touchmove', onResizeMove, { passive: false }); document.addEventListener('mouseup', onResizeEnd); document.addEventListener('touchend', onResizeEnd); }
            function onResizeMove(e) { if(e.type === 'touchmove') e.preventDefault(); const pointer = getPointerPosition(e); const newWidth = initialWidth + (pointer.clientX - initialX); const newHeight = initialHeight + (pointer.clientY - initialY); if (newWidth > 300) { element.style.width = newWidth + 'px'; } if (newHeight > 200) { element.style.height = newHeight + 'px'; } }
            function onResizeEnd() { document.removeEventListener('mousemove', onResizeMove); document.removeEventListener('touchmove', onResizeMove); document.removeEventListener('mouseup', onResizeEnd); document.removeEventListener('touchend', onResizeEnd); }
            handle.addEventListener('mousedown', onResizeStart);
            handle.addEventListener('touchstart', onResizeStart, { passive: false });
        }

        function getYoutubeVideoId(url) { if (!url) return null; const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/; return (url.match(regex) || [])[1] || null; }
        function getTweetId(url) { if (!url) return null; const regex = /(?:https?:\/\/)?(?:www\.)?(?:twitter|x)\.com\/(?:\w+)\/status\/(\d+)/; return (url.match(regex) || [])[1] || null; }
        function isDirectVideo(url) { return /\.(mp4|webm|ogv)$/.test(url); }
        function updateUsername(newName) { if (!newName || newName === username) return; username = newName; myUserRef.update({ name: newName }); }
        function sendMessage() { const text = messageInput.value.trim(); if (!text) return; const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }); db.ref("messages").push().set({ user: username, text, time, avatar: myAvatarUrl }); messageInput.value = ""; }
        submitVideoUrlBtn.onclick = () => { const url = videoUrlInput.value.trim(); if (!url) return; const youtubeId = getYoutubeVideoId(url); const tweetId = getTweetId(url); if (youtubeId) { db.ref("pinned_video").set({ type: 'youtube', id: youtubeId, setBy: username }); } else if (tweetId) { db.ref("pinned_video").set({ type: 'twitter', id: tweetId, setBy: username }); } else if (url.toLowerCase().includes('.m3u')) { db.ref("pinned_video").set({ type: 'm3u', url: url, setBy: username }); } else if (isDirectVideo(url)) { db.ref("pinned_video").set({ type: 'direct', url: url, setBy: username }); } else { alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…."); return; } closeAllModals(); };
        
        // **MOST ROBUST IMPLEMENTATION**
        db.ref("online").on("value", (snap) => {
            const allUsersFromDB = snap.val() || {};
            const GHOST_TIMEOUT = 5 * 60 * 1000;
            const validUsers = {};
            let isCleaning = false;

            // Step 1: Filter out ghost users and prepare a clean list
            Object.entries(allUsersFromDB).forEach(([key, userData]) => {
                if ((Date.now() - userData.last_seen) > GHOST_TIMEOUT) {
                    isCleaning = true;
                    db.ref(`online/${key}`).remove(); // Send remove command in the background
                } else {
                    validUsers[key] = userData; // This user is valid, add them to our clean list
                }
            });
            
            // Step 2: ALWAYS update the visual list IMMEDIATELY with the clean data
            const validUsersArray = Object.values(validUsers);
            usersList.innerHTML = "";
            validUsersArray.forEach(user => {
                const userItem = document.createElement("div");
                userItem.className = "user-item";
                userItem.innerHTML = `<img src="${user.avatar || defaultAvatarUrl}" class="user-list-avatar">
                                      <div class="status-dot ${user.status === 'active' ? 'status-active' : 'status-idle'}"></div>
                                      <span>${user.name}</span>`;
                usersList.appendChild(userItem);
            });
            count.textContent = validUsersArray.length;

            // Step 3: Only process notifications if we are NOT in a cleaning cycle
            if (!isCleaning && initialUsersLoaded) {
                // Check for users who left (are in cache but not in the new valid list)
                Object.keys(onlineUsersCache).forEach(userId => {
                    if (!validUsers[userId]) {
                        addNotification(onlineUsersCache[userId].name, 'ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©', onlineUsersCache[userId].avatar);
                    }
                });

                // Check for users who joined or changed name
                Object.keys(validUsers).forEach(userId => {
                    if (!onlineUsersCache[userId] && userId !== myUserId) {
                        addNotification(validUsers[userId].name, 'Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©', validUsers[userId].avatar);
                    } else if (onlineUsersCache[userId] && validUsers[userId].name !== onlineUsersCache[userId].name) {
                        addNotification(validUsers[userId].name, `âœï¸ ØºÙŠØ± Ø§Ø³Ù…Ù‡ Ù…Ù† ${onlineUsersCache[userId].name}`, validUsers[userId].avatar);
                    }
                });
            }
            
            // Step 4: Update the cache with the latest valid user list for the next check
            onlineUsersCache = validUsers;
            initialUsersLoaded = true;
        });

        loadInitialMessages();

        db.ref("pinned_video").on("value", async (snap) => {
            const data = snap.val();
            if (videoPlayerInstance) { videoPlayerInstance.dispose(); videoPlayerInstance = null; }
            pinnedVideoPlayer.innerHTML = ''; 

            if (data) {
                pinnedVideoPlayer.style.display = 'flex';
                const header = document.createElement('div'); header.className = 'video-header'; header.innerHTML = `<span>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</span>`;
                const closeBtn = document.createElement('button'); closeBtn.className = 'close-pinned-video'; closeBtn.innerHTML = 'âœ–';
                closeBtn.onclick = () => db.ref("pinned_video").remove();
                header.appendChild(closeBtn);
                const body = document.createElement('div'); body.className = 'video-body';
                const resizeHandle = document.createElement('div'); resizeHandle.className = 'resize-handle';
                pinnedVideoPlayer.appendChild(header); pinnedVideoPlayer.appendChild(body); pinnedVideoPlayer.appendChild(resizeHandle);
                makeDraggable(pinnedVideoPlayer, header); makeResizable(pinnedVideoPlayer, resizeHandle);

                let videoSource = null; let videoType = '';
                if (data.type === 'youtube') { videoSource = `https://www.youtube.com/watch?v=${data.id}`; videoType = 'video/youtube'; } 
                else if (data.type === 'm3u') { videoSource = data.url; videoType = 'application/x-mpegURL'; } 
                else if (data.type === 'direct') { videoSource = data.url; videoType = 'video/mp4'; } 
                else if (data.type === 'twitter') {
                    try {
                        const response = await fetch(`https://api.vxtwitter.com/i/status/${data.id}`);
                        const tweetData = await response.json();
                        if (tweetData.media_extended && tweetData.media_extended.length > 0) { videoSource = tweetData.media_extended[0].url; videoType = 'video/mp4'; } 
                        else { body.innerHTML = `<p style="color:white;padding:10px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆ.</p>`; }
                    } catch (error) { console.error("Error fetching Twitter video:", error); body.innerHTML = `<p style="color:white;padding:10px;">Ø­Ø¯Ø« Ø®Ø·Ø£.</p>`; }
                }

                if (videoSource) {
                    const videoEl = document.createElement('video-js'); videoEl.className = 'vjs-netflix-theme'; body.appendChild(videoEl);
                    let playerOptions = { autoplay: true, muted: true, controls: true, aspectRatio: '16:9', playsinline: true, techOrder: data.type === 'youtube' ? ['youtube'] : ['html5'], sources: [{ type: videoType, src: videoSource }] };
                    videoPlayerInstance = videojs(videoEl, playerOptions);
                }

                if (initialUsersLoaded && data) {
                    const setterName = data.setBy; let setterAvatar = defaultAvatarUrl;
                    const setter = Object.values(onlineUsersCache).find(u => u.name === setterName);
                    if (setter) { setterAvatar = setter.avatar; }
                    addNotification(setterName, 'ğŸ“º Ù‚Ø§Ù… Ø¨ØªØ´ØºÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯', setterAvatar);
                }
            } else { pinnedVideoPlayer.style.display = 'none'; }
        });
    }
  </script>
</body>
</html>
