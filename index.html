<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ÿ¥ÿßÿ™ ŸÜŸàŸÅ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<style>
html, body { height: 100%; margin: 0; padding: 0; font-family:'Tajawal', sans-serif; background:#ece5dd; }
#chat-container { display:flex; flex-direction:column; height:100%; max-width: 500px; margin:auto; border:1px solid #ccc; background:white; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
#messages { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px; }
.msg { max-width:70%; padding:8px 12px; border-radius:20px; position:relative; word-wrap:break-word; line-height:1.4; font-size:15px; }
.msg.self { background:#dcf8c6; align-self:flex-end; border-bottom-right-radius:4px; }
.msg.other { background:#fff; align-self:flex-start; border-bottom-left-radius:4px; }
.time { font-size:11px; color:#999; margin-top:4px; display:block; text-align:right; }
#typing-indicator { height:20px; padding:0 15px; font-size:13px; color:#888; font-style:italic; }
#inputArea { display:flex; border-top:1px solid #ccc; padding:8px; background:#f0f0f0; gap:8px; }
#messageInput { flex:1; padding:10px 15px; border-radius:20px; border:1px solid #ccc; font-size:15px; outline:none; }
#sendBtn { padding:10px 15px; border:none; border-radius:20px; background:#25d366; color:white; cursor:pointer; font-size:15px; }
#onlineList { position:fixed; top:10px; left:50%; transform:translateX(-50%); background:white; border-radius:20px; padding:5px 12px; font-size:14px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer; }
#usersBox { position:fixed; top:40px; left:50%; transform:translateX(-50%); background:white; border-radius:8px; padding:10px; box-shadow:0 4px 12px rgba(0,0,0,0.15); opacity:0; visibility:hidden; transition:0.2s; max-height:200px; overflow-y:auto;}
#usersBox.visible { opacity:1; visibility:visible; }
.user-item { display:flex; align-items:center; gap:8px; padding:4px 0; font-size:14px; }
.status-indicator { width:10px; height:10px; border-radius:50%; }
.status-green { background:#28a745; }
.status-yellow { background:#ffc107; }
</style>
</head>
<body>
<div id="chat-container">
  <div id="messages"></div>
  <div id="typing-indicator"></div>
  <form id="inputArea" action="javascript:void(0);">
    <input type="text" id="messageInput" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." autocomplete="off">
    <button type="submit" id="sendBtn">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
  </form>
</div>
<div id="onlineList">üë• <span id="count">0</span></div>
<div id="usersBox"><h4>ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ ÿßŸÑÿ¢ŸÜ</h4><div id="usersList"></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
 const firebaseConfig = {
      apiKey: "AIzaSyDttyEjbuC6gzHxuN0IR8yi_9fO-aFyW64",
      authDomain: "studio-4914109762-6a41f.firebaseapp.com",
      databaseURL: "https://studio-4914109762-6a41f-default-rtdb.firebaseio.com",
      projectId: "studio-4914109762-6a41f",
      storageBucket: "studio-4914109762-6a41f.firebasestorage.app",
      messagingSenderId: "134781295069",
      appId: "1:134781295069:web:3c020f46f8fbeaca24fe34"
    };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let username = localStorage.getItem('chatUsername');
if(!username){ while(true){ username=prompt("ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ ŸÑŸÑÿßŸÜÿ∂ŸÖÿßŸÖ:"); if(username && username.trim()!="") break; } localStorage.setItem('chatUsername', username.trim()); }

const sessionUid='uid_'+Date.now()+Math.random().toString(36).substr(2,9);
const userRef=db.ref("online/"+username);
const messagesRef=db.ref("messages");
const onlineRef=db.ref("online");

const messagesDiv=document.getElementById("messages");
const typingIndicator=document.getElementById("typing-indicator");
const messageInput=document.getElementById("messageInput");
const inputAreaForm=document.getElementById("inputArea");
const onlineList=document.getElementById("onlineList");
const usersBox=document.getElementById("usersBox");
const usersList=document.getElementById("usersList");
const count=document.getElementById("count");

let typingTimer, serverTimeOffset=0;

// ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
userRef.set({ lastActive:firebase.database.ServerValue.TIMESTAMP, isTyping:false });
userRef.onDisconnect().remove();
db.ref('.info/serverTimeOffset').on('value',snap=>{ serverTimeOffset=snap.val()||0; });

// ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ¥ÿßÿ∑
setInterval(()=>{ userRef.update({lastActive:firebase.database.ServerValue.TIMESTAMP}); },30000);
setInterval(()=>{
const now=Date.now()+serverTimeOffset;
onlineRef.once('value',snap=>{
const users=snap.val(); if(!users) return;
Object.keys(users).forEach(u=>{ if(now-(users[u].lastActive||0)>90000) db.ref('online/'+u).remove(); });
}); },60000);

// ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
onlineList.onclick=e=>{ e.stopPropagation(); usersBox.classList.toggle('visible'); }
document.onclick=()=>{ if(usersBox.classList.contains('visible')) usersBox.classList.remove('visible'); }
usersBox.onclick=e=>e.stopPropagation();

// ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ
onlineRef.on("value",snap=>{
const users=snap.val()||{};
count.textContent=snap.numChildren();
renderUsersList(users);
updateTypingIndicator(users);
});
onlineRef.on("child_added",snap=>{ if(snap.key!==username) showSystemMsg(`üì• ${snap.key} ÿØÿÆŸÑ ÿßŸÑÿØÿ±ÿØÿ¥ÿ©`); });
onlineRef.on("child_removed",snap=>{ showSystemMsg(`üì§ ${snap.key} ÿ∫ÿßÿØÿ± ÿßŸÑÿØÿ±ÿØÿ¥ÿ©`); });

inputAreaForm.onsubmit=sendMessage;
messageInput.oninput=()=>{
clearTimeout(typingTimer);
userRef.update({isTyping:true,lastActive:firebase.database.ServerValue.TIMESTAMP});
typingTimer=setTimeout(()=>{ userRef.update({isTyping:false});},2000);
};

function sendMessage(){
clearTimeout(typingTimer);
userRef.update({isTyping:false});
const text=messageInput.value.trim(); if(!text) return;
const time=new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'});
messagesRef.push().set({user:username,text,time,uid:sessionUid});
messageInput.value="";
}

function addMessage(key,{user,text,time,uid}){
const div=document.createElement("div");
div.className='msg '+(uid===sessionUid?'self':'other');
div.innerHTML=`${text}<span class="time">${time}</span>`;
messagesDiv.appendChild(div);
messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
messagesRef.limitToLast(50).on("child_added",snap=>addMessage(snap.key,snap.val()));

function updateTypingIndicator(users){
const typingUsers=Object.keys(users).filter(u=>users[u].isTyping && u!==username);
if(typingUsers.length===0) typingIndicator.textContent='';
else if(typingUsers.length===1) typingIndicator.textContent=`${typingUsers[0]} ŸäŸÉÿ™ÿ® ÿßŸÑÿ¢ŸÜ...`;
else if(typingUsers.length===2) typingIndicator.textContent=`${typingUsers[0]} Ÿà ${typingUsers[1]} ŸäŸÉÿ™ÿ®ÿßŸÜ ÿßŸÑÿ¢ŸÜ...`;
else typingIndicator.textContent=`ÿπÿØÿ© ÿ£ÿ¥ÿÆÿßÿµ ŸäŸÉÿ™ÿ®ŸàŸÜ ÿßŸÑÿ¢ŸÜ...`;
}

function renderUsersList(users){
usersList.innerHTML='';
const now=Date.now()+serverTimeOffset;
const twoMinutesAgo=now-(2*60*1000);
Object.keys(users).forEach(user=>{
const uData=users[user];
const item=document.createElement("div"); item.className="user-item";
const status=document.createElement("span"); status.className="status-indicator";
status.classList.add(uData.lastActive<twoMinutesAgo?'status-yellow':'status-green');
const uname=document.createElement("span"); uname.textContent=user;
item.appendChild(status); item.appendChild(uname); usersList.appendChild(item);
});
}

function showSystemMsg(text){
const div=document.createElement("div"); div.className="sys"; div.textContent=text;
messagesDiv.appendChild(div); messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
});
</script>
</body>
</html>
