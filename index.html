<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø´Ø§Øª Ù†ÙˆÙ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <script src="https://unpkg.com/videojs-youtube/dist/Youtube.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: 'Tajawal', sans-serif; background: #f4f7f9; display: flex; flex-direction: column; position: relative; }
    #chat-container { display: flex; flex-direction: column; height: 100%; }
    
    #messages { flex: 1; overflow-y: auto; padding: 15px; background: #fff; scroll-behavior: smooth; }
    
    .msg { margin: 8px 0; display: flex; gap: 10px; align-items: center; direction: ltr; text-align: left; font-size: 15px; line-height: 1.4; }
    .sys { text-align: center; color: #888; font-size: 12px; margin: 10px auto; font-style: italic; background-color: #f0f0f0; padding: 4px 10px; border-radius: 12px; transition: opacity 0.5s; }
    
    .user { font-weight: bold; color: #005c97; }
    
    .time { font-size: 11px; color: #999; min-width: 40px; }
    
    #inputArea {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: #ffffff;
      border-top: none;
    }

    #messageInput { 
      flex: 1; 
      font-size: 16px; 
      height: 45px;
      padding: 0 15px;
      border: 1px solid #eee;
      border-radius: 25px; 
      font-family: 'Tajawal', sans-serif; 
      background: #ffffff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
      box-sizing: border-box;
    }
    #messageInput:focus { border-color: #3366cc; outline: none; }
    
    #sendBtn { 
      height: 45px;
      padding: 0 25px; 
      border: none; 
      border-radius: 25px; 
      background: #3366cc; 
      color: white; 
      cursor: pointer; 
      font-family: 'Tajawal', sans-serif;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex; 
      align-items: center; 
      justify-content: center;
      box-sizing: border-box;
    }

    #sendBtn:hover { background: #254e99; }
    
    #topButtons { position: fixed; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000; }
    .btn { padding: 6px 10px; background: white; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; font-size: 16px; line-height: 1; display: flex; align-items: center; }
    .btn .count-text { font-size: 14px; margin-right: 4px; }
    
    #onlineList { position: fixed; top: 10px; right: 10px; border: 1px solid #ccc; background: white; padding: 8px 14px; border-radius: 20px; font-size: 14px; cursor: pointer; z-index: 1000; display: flex; align-items: center; gap: 5px; }
    #usersBox, #setVideoModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1003; display: none; max-height: 80vh; overflow-y: auto; }
    #usersList { max-height: 200px; overflow-y: auto; }
    .user-item { display: flex; align-items: center; gap: 8px; padding: 5px 2px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; }
    .status-green { background-color: #28a745; } .status-yellow { background-color: #ffc107; } .status-gray { background-color: #ccc; }
    
    .delete-btn { display:none; }

    #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10000; }
    #loginBox { background: white; padding: 30px; border-radius: 15px; text-align: center; min-width: 300px; }
    #usernameInput { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; box-sizing: border-box; font-family: 'Tajawal', sans-serif;}
    #loginBtn { background: #3366cc; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; font-family: 'Tajawal', sans-serif; margin-top: 10px; }
    
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; }
    
    #pinnedVideoPlayer { position: fixed; top: 50px; left: 50px; width: clamp(300px, 90vw, 480px); background: #000; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 998; display: none; flex-direction: column; overflow: hidden; }
    .video-header { background-color: #333; color: white; padding: 5px 10px; border-top-left-radius: 7px; border-top-right-radius: 7px; cursor: move; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; touch-action: none; font-size: 14px; }
    .video-body { width: 100%; background: #000; flex-grow: 1; }
    .video-js .vjs-tech { object-fit: contain; }
    .close-pinned-video { background: #d9534f; border: 1px solid #d43f3a; color: white; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 14px; line-height: 20px; text-align: center; }
    .resize-handle { position: absolute; width: 20px; height: 20px; bottom: 0; right: 0; cursor: nwse-resize; z-index: 10; }
    
    .video-js.vjs-netflix-theme { background-color: #000; }
    .vjs-netflix-theme .vjs-control-bar { height: 6em; background: none; background-image: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%); }
    .vjs-netflix-theme .vjs-big-play-button { display: none !important; }
    .vjs-netflix-theme .vjs-progress-control { position: absolute; left: 0; right: 0; width: 100%; top: -3em; height: 2.5em; }
    .vjs-netflix-theme .vjs-progress-holder { height: 0.3em; margin: 1.1em 0; }
    .vjs-netflix-theme .vjs-play-progress, .vjs-netflix-theme .vjs-load-progress { height: 100%; }
    .vjs-netflix-theme .vjs-play-progress:before { display: none; }
    .vjs-netflix-theme .vjs-play-progress { background-color: #e50914; }
    .vjs-netflix-theme .vjs-load-progress { background: rgba(255, 255, 255, 0.4); }
    .vjs-netflix-theme .vjs-time-control { line-height: 5em; padding: 0 1em; }
    .vjs-netflix-theme .vjs-remaining-time { line-height: 5em; }
    .vjs-netflix-theme .vjs-button > .vjs-icon-placeholder:before { font-size: 2.2em; line-height: 2.2; }
    .vjs-netflix-theme .vjs-volume-panel, .vjs-netflix-theme .vjs-fullscreen-control { margin-right: 1em; }
    .video-js.vjs-netflix-theme.vjs-has-started.vjs-user-inactive .vjs-control-bar { opacity: 0; visibility: hidden; }

    .video-selector-bar { display: flex; gap: 6px; padding: 8px; background: #111; overflow-x: auto; border-bottom: 1px solid #333; max-height: 60px; }
    .video-selector-btn { flex-shrink: 0; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 12px; font-family: 'Tajawal', sans-serif; transition: all 0.2s; }
    .video-selector-btn:hover { background: #333; border-color: #666; }
    .video-selector-btn.active { background: #e50914; border-color: #c40812; }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div id="loginBox">
      <h2>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
      <input type="text" id="usernameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©)" maxlength="15" autofocus>
      <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div id="chat-container" style="display: none;">
    <div id="topButtons">
      <div class="btn" id="setVideoBtn" title="ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ">ğŸ“º</div>
      <div class="btn" id="onlineListBtn" title="Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†">ğŸ‘¥ <span id="count" class="count-text">0</span></div>
    </div>
    
    <div id="pinnedVideoPlayer"></div>
    
    <div id="setVideoModal">
      <h4>ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¬Ù…ÙŠØ¹</h4>
      <input type="text" id="videoUrlInput" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ ØªÙˆÙŠØªØ±ØŒ M3UØŒ Ø£Ùˆ MP4"/>
      <button id="submitVideoUrlBtn">ØªØ«Ø¨ÙŠØª</button>
    </div>
    
    <div id="usersBox">
      <h4>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</h4>
      <div id="usersList"></div>
    </div>
    
    <div id="overlay"></div>
    
    <div id="messages" role="list"></div>
    
    <form id="inputArea">
      <button type="submit" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" />
    </form>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyDttyEjbuC6gzHxuN0IR8yi_9fO-aFyW64",
      authDomain: "studio-4914109762-6a41f.firebaseapp.com",
      databaseURL: "https://studio-4914109762-6a41f-default-rtdb.firebaseio.com",
      projectId: "studio-4914109762-6a41f",
      storageBucket: "studio-4914109762-6a41f.firebasestorage.app",
      messagingSenderId: "134781295069",
      appId: "1:134781295069:web:3c020f46f8fbeaca24fe34"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let username = '';
    let userRef, messagesRef, onlineRef, pinnedVideoRef;
    let serverTimeOffset = 0;
    let videoPlayerInstance = null;
    let currentVideoIndex = 0;
    let currentVideosList = [];

    const loginScreen = document.getElementById('loginScreen');
    const usernameInput = document.getElementById('usernameInput');
    const loginBtn = document.getElementById('loginBtn');
    const chatContainer = document.getElementById('chat-container');
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const onlineListBtn = document.getElementById("onlineListBtn");
    const setVideoBtn = document.getElementById("setVideoBtn");
    const usersBox = document.getElementById("usersBox");
    const setVideoModal = document.getElementById("setVideoModal");
    const videoUrlInput = document.getElementById("videoUrlInput");
    const submitVideoUrlBtn = document.getElementById("submitVideoUrlBtn");
    const pinnedVideoPlayer = document.getElementById("pinnedVideoPlayer");
    const overlay = document.getElementById("overlay");

    function attemptLogin() {
        let inputName = usernameInput.value.trim();
        const invalidChars = /[.#$\\[\\]]/;
        if (invalidChars.test(inputName)) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©");
            return;
        }
        if (inputName.length < 2) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");
            return;
        }

        username = inputName;
        userRef = db.ref("online/" + username);
        messagesRef = db.ref("messages");
        onlineRef = db.ref("online");
        pinnedVideoRef = db.ref("pinned_video");
        
        startChat();
    }

    loginBtn.onclick = attemptLogin;
    usernameInput.onkeypress = (e) => { if (e.key === 'Enter') attemptLogin(); };

    function startChat() {
      loginScreen.style.display = 'none';
      chatContainer.style.display = 'flex';

      db.ref('.info/serverTimeOffset').on('value', snap => serverTimeOffset = snap.val() || 0);

      userRef.set({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      userRef.onDisconnect().remove();

      setInterval(() => {
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      }, 60000);

      setInterval(() => {
         const now = Date.now() + serverTimeOffset;
         onlineRef.once('value', snap => {
             snap.forEach(child => {
                 if (now - child.val().lastActive > 90000) child.ref.remove();
             });
         });
      }, 60000);

      onlineListBtn.onclick = (e) => { e.stopPropagation(); usersBox.style.display = 'block'; overlay.style.display = 'block'; };
      setVideoBtn.onclick = (e) => { e.stopPropagation(); setVideoModal.style.display = 'block'; overlay.style.display = 'block'; };
      overlay.onclick = closeAllModals;
      
      document.getElementById("inputArea").onsubmit = (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;
        
        const time = new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false});
        messagesRef.push({ user: username, text: text, time: time, timestamp: firebase.database.ServerValue.TIMESTAMP });
        messageInput.value = "";
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
        scrollToBottom();
      };

      messagesRef.limitToLast(100).on("child_added", snap => {
        addMessageToUI(snap.key, snap.val());
      });

      messagesRef.on("child_removed", snap => {
        const msgElement = document.getElementById(`msg-${snap.key}`);
        if (msgElement) {
            msgElement.style.opacity = '0';
            setTimeout(() => msgElement.remove(), 300);
        }
      });

      onlineRef.on("value", snap => {
        document.getElementById("count").textContent = snap.numChildren();
        renderUsersList(snap.val() || {});
      });

      submitVideoUrlBtn.onclick = () => {
        const url = videoUrlInput.value.trim();
        if (!url) return;
        
        const youtubeId = getYoutubeVideoId(url);
        const tweetId = getTweetId(url);
        
        if (youtubeId) {
          pinnedVideoRef.set({ type: 'youtube', id: youtubeId, setBy: username });
        } else if (tweetId) {
          pinnedVideoRef.set({ type: 'twitter', id: tweetId, setBy: username });
        } else if (url.toLowerCase().includes('.m3u')) {
          pinnedVideoRef.set({ type: 'm3u', url: url, setBy: username });
        } else if (isDirectVideo(url)) {
          pinnedVideoRef.set({ type: 'direct', url: url, setBy: username });
        } else {
          alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….");
          return;
        }
        
        videoUrlInput.value = "";
        closeAllModals();
      };

      pinnedVideoRef.on("value", async (snap) => {
        const data = snap.val();
        if (videoPlayerInstance) {
          videoPlayerInstance.dispose();
          videoPlayerInstance = null;
        }
        pinnedVideoPlayer.innerHTML = '';
        currentVideosList = [];
        currentVideoIndex = 0;

        if (data) {
          pinnedVideoPlayer.style.display = 'flex';
          const header = document.createElement('div');
          header.className = 'video-header';
          header.innerHTML = `<span>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± - ${data.setBy}</span>`;
          const closeBtn = document.createElement('button');
          closeBtn.className = 'close-pinned-video';
          closeBtn.innerHTML = 'âœ–';
          closeBtn.onclick = () => pinnedVideoRef.remove();
          header.appendChild(closeBtn);
          const body = document.createElement('div');
          body.className = 'video-body';
          
          const resizeHandle = document.createElement('div');
          resizeHandle.className = 'resize-handle';
          
          pinnedVideoPlayer.appendChild(header);
          pinnedVideoPlayer.appendChild(body);
          pinnedVideoPlayer.appendChild(resizeHandle);
          
          makeDraggable(pinnedVideoPlayer, header);
          makeResizable(pinnedVideoPlayer, resizeHandle);

          if (data.type === 'youtube') {
            createVideoPlayer(body, `https://www.youtube.com/watch?v=${data.id}`, 'video/youtube', true);
          } else if (data.type === 'm3u') {
            createVideoPlayer(body, data.url, 'application/x-mpegURL', false);
          } else if (data.type === 'direct') {
            createVideoPlayer(body, data.url, 'video/mp4', false);
          } else if (data.type === 'twitter') {
            const videos = await fetchTwitterVideos(data.id);
            if (!videos || !videos.length) {
              body.innerHTML = `<p style="color:white;padding:10px;">ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ ÙÙŠØ¯ÙŠÙˆ ØªÙˆÙŠØªØ± (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø®Ø§ØµØ§Ù‹ Ø£Ùˆ Ù…Ø­Ø°ÙˆÙØ§Ù‹ Ø£Ùˆ Ø®Ø¯Ù…Ø© Ø§Ù„ÙˆØ³ÙŠØ· Ù…ØªÙˆÙ‚ÙØ©).</p>`;
            } else {
              currentVideosList = videos;
              currentVideoIndex = 0;
              createVideoPlayer(body, videos[0].url, 'video/mp4', false);
              
              if (videos.length > 1) {
                createVideoSelector(body, videos);
              }
            }
          }

          addNotification(`${data.setBy} Ù‚Ø§Ù… Ø¨ØªØ´ØºÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ`);
        } else {
          pinnedVideoPlayer.style.display = 'none';
        }
      });
    }

    function createVideoPlayer(container, videoSource, videoType, isYoutube) {
      const videoEl = document.createElement('video-js');
      videoEl.className = 'vjs-netflix-theme';
      container.innerHTML = '';
      container.appendChild(videoEl);

      let playerOptions = {
        autoplay: true,
        muted: true,
        controls: true,
        aspectRatio: '16:9',
        playsinline: true,
        techOrder: isYoutube ? ['youtube'] : ['html5'],
        sources: [{ type: videoType, src: videoSource }]
      };
      
      videoPlayerInstance = videojs(videoEl, playerOptions);
    }

    function createVideoSelector(container, videos) {
      const selectorBar = document.createElement('div');
      selectorBar.className = 'video-selector-bar';

      videos.forEach((v, idx) => {
        const btn = document.createElement('button');
        btn.className = 'video-selector-btn';
        btn.textContent = `Ù…Ù‚Ø·Ø¹ ${idx + 1}`;
        if (idx === 0) btn.classList.add('active');
        
        btn.onclick = (e) => {
          e.preventDefault();
          if (idx !== currentVideoIndex && videoPlayerInstance) {
            currentVideoIndex = idx;
            videoPlayerInstance.src({ src: v.url, type: 'video/mp4' });
            videoPlayerInstance.play();
            
            document.querySelectorAll('.video-selector-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          }
        };
        selectorBar.appendChild(btn);
      });

      container.appendChild(selectorBar);
    }

    async function fetchTwitterVideos(tweetId) {
      const videos = [];

      try {
        const fxRes = await fetch(`https://api.fxtwitter.com/status/${tweetId}`);
        if (fxRes.ok) {
          const fxData = await fxRes.json();
          const tweet = fxData.tweet || {};
          const media = tweet.media || {};
          
          if (Array.isArray(media.videos)) {
            media.videos.forEach(v => {
              if (v && v.url) {
                videos.push({
                  url: v.url,
                  thumb: v.thumbnail_url || '',
                  type: v.type || 'video',
                  provider: 'fxtwitter'
                });
              }
            });
          } else if (Array.isArray(media.all)) {
            media.all
              .filter(m => m.type === 'video' || m.type === 'gif')
              .forEach(v => {
                if (v && v.url) {
                  videos.push({
                    url: v.url,
                    thumb: v.thumbnail_url || '',
                    type: v.type || 'video',
                    provider: 'fxtwitter'
                  });
                }
              });
          }
        }
      } catch (e) {
        console.warn('FixTweet error:', e);
      }

      if (!videos.length) {
        try {
          const vxRes = await fetch(`https://api.vxtwitter.com/i/status/${tweetId}`);
          if (vxRes.ok) {
            const vxData = await vxRes.json();
            const mediaExt = vxData.media_extended || [];
            mediaExt.forEach(m => {
              if (m && m.url) {
                videos.push({
                  url: m.url,
                  thumb: m.thumbnail_url || '',
                  type: m.type || 'video',
                  provider: 'vxtwitter'
                });
              }
            });
          }
        } catch (e) {
          console.warn('vxtwitter error:', e);
        }
      }

      return videos;
    }

    function addMessageToUI(key, { user, text, time, timestamp }) {
      const div = document.createElement("div");
      div.className = "msg";
      div.id = `msg-${key}`;
      
      const timeElement = document.createElement("span");
      timeElement.className = "time";
      timeElement.id = `time-${key}`;
      
      updateTimeDisplay(key, timestamp, timeElement);
      
      div.innerHTML = `
        <span class="user">${escapeHtml(user)}</span>
        <span style="flex:1; word-break: break-word;">${escapeHtml(text)}</span>
      `;
      
      div.appendChild(timeElement);

      messagesDiv.appendChild(div);
      scrollToBottom();
      
      setInterval(() => {
        updateTimeDisplay(key, timestamp, timeElement);
      }, 60000);
    }

    function updateTimeDisplay(key, timestamp, timeElement) {
      if (!timestamp) return;
      
      const now = Date.now() + serverTimeOffset;
      const messageTime = timestamp + serverTimeOffset;
      const diffMs = now - messageTime;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHours = Math.floor(diffMin / 60);
      const diffDays = Math.floor(diffHours / 24);
      const diffWeeks = Math.floor(diffDays / 7);
      const diffMonths = Math.floor(diffDays / 30);
      const diffYears = Math.floor(diffDays / 365);
      
      let timeText = "";
      
      if (diffSec < 5) {
        timeText = "Ø§Ù„Ø¢Ù†";
      } else if (diffSec < 60) {
        timeText = "Ø«ÙˆØ§Ù†ÙŠ";
      } else if (diffMin < 2) {
        timeText = "Ø¯1";
      } else if (diffMin < 60) {
        timeText = `Ø¯${diffMin}`;
      } else if (diffHours < 24) {
        timeText = `Ø³${diffHours}`;
      } else if (diffDays < 7) {
        timeText = `ÙŠ${diffDays}`;
      } else if (diffWeeks < 4) {
        timeText = `Ø£${diffWeeks}`;
      } else if (diffMonths < 12) {
        timeText = `Ø´${diffMonths}`;
      } else {
        timeText = `Ø¹${diffYears}`;
      }
      
      timeElement.textContent = timeText;
    }

    function addNotification(text) {
      const div = document.createElement("div");
      div.className = "sys";
      div.textContent = text;
      messagesDiv.appendChild(div);
      scrollToBottom();
    }

    function renderUsersList(users) {
        const list = document.getElementById("usersList");
        list.innerHTML = '';
        const now = Date.now() + serverTimeOffset;
        Object.keys(users).forEach(uName => {
            const uData = users[uName];
            const div = document.createElement("div");
            div.className = "user-item";
            let colorClass = 'status-green';
            const diff = now - (uData.lastActive || 0);
            if (diff > 60000) colorClass = 'status-gray';
            else if (diff > 30000) colorClass = 'status-yellow';
            div.innerHTML = `<span class="status-indicator ${colorClass}"></span><span>${escapeHtml(uName)}</span>`;
            list.appendChild(div);
        });
    }

    function closeAllModals() {
      usersBox.style.display = 'none';
      setVideoModal.style.display = 'none';
      overlay.style.display = 'none';
    }

    function makeDraggable(element, handle) {
      let offsetX = 0, offsetY = 0;
      let isDragging = false;
      
      const getPointerPosition = (e) => e.touches ? e.touches[0] : e;
      
      const onDragStart = (e) => {
        isDragging = true;
        const pointer = getPointerPosition(e);
        offsetX = pointer.clientX - element.offsetLeft;
        offsetY = pointer.clientY - element.offsetTop;
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchend', onDragEnd);
      };
      
      const onDragMove = (e) => {
        if (isDragging) {
          e.preventDefault();
          const pointer = getPointerPosition(e);
          element.style.left = (pointer.clientX - offsetX) + "px";
          element.style.top = (pointer.clientY - offsetY) + "px";
        }
      };
      
      const onDragEnd = () => {
        isDragging = false;
        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchend', onDragEnd);
      };
      
      handle.addEventListener('mousedown', onDragStart);
      handle.addEventListener('touchstart', onDragStart, { passive: false });
    }

    function makeResizable(element, handle) {
      let initialWidth, initialHeight, initialX, initialY;
      const getPointerPosition = (e) => e.touches ? e.touches[0] : e;

      function onResizeStart(e) {
        if(e.type === 'touchstart') e.preventDefault();
        const pointer = getPointerPosition(e);
        initialWidth = element.offsetWidth;
        initialHeight = element.offsetHeight;
        initialX = pointer.clientX;
        initialY = pointer.clientY;
        document.addEventListener('mousemove', onResizeMove);
        document.addEventListener('touchmove', onResizeMove, { passive: false });
        document.addEventListener('mouseup', onResizeEnd);
        document.addEventListener('touchend', onResizeEnd);
      }

      function onResizeMove(e) {
        if(e.type === 'touchmove') e.preventDefault();
        const pointer = getPointerPosition(e);
        const newWidth = initialWidth + (pointer.clientX - initialX);
        const newHeight = initialHeight + (pointer.clientY - initialY);
        if (newWidth > 300) { element.style.width = newWidth + 'px'; }
        if (newHeight > 200) { element.style.height = newHeight + 'px'; }
      }

      function onResizeEnd() {
        document.removeEventListener('mousemove', onResizeMove);
        document.removeEventListener('touchmove', onResizeMove);
        document.removeEventListener('mouseup', onResizeEnd);
        document.removeEventListener('touchend', onResizeEnd);
      }
      
      handle.addEventListener('mousedown', onResizeStart);
      handle.addEventListener('touchstart', onResizeStart, { passive: false });
    }

    function getYoutubeVideoId(url) {
      if (!url) return null;
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      return (url.match(regex) || [])[1] || null;
    }

    function getTweetId(url) {
      if (!url) return null;
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:twitter|x)\.com\/(?:\w+)\/status\/(\d+)/;
      return (url.match(regex) || [])[1] || null;
    }

    function isDirectVideo(url) {
      return /\.(mp4|webm|ogv)$/i.test(url);
    }

    function scrollToBottom() { messagesDiv.scrollTop = messagesDiv.scrollHeight; }
    function escapeHtml(unsafe) { if(!unsafe) return ""; return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
  });
</script>
</body>
</html>
