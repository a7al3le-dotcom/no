<!DOCTYPE html>
<html lang="ar" hreflang="ar-sa" style="height: 100%;">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <title>Ø´Ø§Øª Ù†ÙˆÙ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  <style>
    body { margin: 0; font-family: 'Tajawal', sans-serif; overflow: hidden; background-color: #f0f2f5; }
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; z-index: 2000; direction: rtl; }
    #loginBox { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 100%; max-width: 400px; }
    .nav-tabs { display: flex; list-style: none; padding: 0; margin: 0; border-bottom: 1px solid #ddd; }
    .nav-tabs li { flex: 1; text-align: center; }
    .nav-tabs li a { display: block; padding: 12px 6px; text-decoration: none; color: #555; background-color: #f7f7f7; border: 1px solid transparent; border-bottom: none; }
    .nav-tabs li.active a { background-color: #fff; border-color: #ddd; border-bottom-color: transparent; border-top-left-radius: 8px; border-top-right-radius: 8px; position: relative; top: 1px; }
    .tab-content { padding: 25px; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .form-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
    .form-submit-btn { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; color: #333; font-size: 16px; cursor: pointer; background-color: #f0f0f0; transition: background-color 0.2s; font-weight: bold; }
    .form-submit-btn:hover { background-color: #e0e0e0; }
    #error-message { color: #fa3e3e; margin-top: 15px; font-size: 14px; height: 20px; text-align: center; }
    #chatContainer { display: none; height: 100vh; position: relative; }
    #topButtons { position: fixed; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000; }
    .btn { padding: 6px 10px; background: white; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; font-size: 16px; line-height: 1; display: flex; align-items: center; }
    .btn .count-text { font-size: 14px; margin-right: 4px; }
    #usersBox, #editNameModal, #setVideoModal, #settingsModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1003; display: none; }
    #usersList { max-height: 200px; overflow-y: auto; }
    #settingsModal { width: 250px; }
    .settings-menu { list-style: none; padding: 0; margin: 0; }
    .settings-menu li { margin-bottom: 10px; }
    .settings-menu button { width: 100%; padding: 12px; text-align: right; font-size: 15px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .settings-menu button:hover { background-color: #e9e9e9; }
    .settings-menu button.logout { color: #d9534f; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; }
    
    /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…ØªØ·ÙˆØ± */
    #pinnedVideoPlayer { 
        position: fixed; 
        top: 100px; 
        left: 100px; 
        width: 640px; 
        height: 360px;
        background: #000; 
        border: 2px solid #337ab7; 
        border-radius: 12px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.6); 
        z-index: 9998; 
        display: none; 
        flex-direction: column;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        resize: both;
        min-width: 320px;
        min-height: 180px;
        max-width: 95vw;
        max-height: 95vh;
    }
    
    .video-player.mini {
        width: 320px !important;
        height: 180px !important;
        bottom: 20px;
        right: 20px;
        top: auto !important;
        left: auto !important;
        transform: none !important;
        border: 1px solid #666;
    }
    
    .video-player.normal {
        width: 640px !important;
        height: 360px !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
    }
    
    .video-player.full {
        width: 100vw !important;
        height: 100vh !important;
        top: 0 !important;
        left: 0 !important;
        transform: none !important;
        z-index: 9999;
        border-radius: 0;
        border: none;
    }
    
    .video-header { 
        background: linear-gradient(135deg, #337ab7, #2e6da4); 
        color: white; 
        padding: 8px 12px; 
        cursor: move; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        flex-shrink: 0; 
        touch-action: none; 
        user-select: none;
        font-weight: bold;
    }
    
    .video-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .control-btn {
        background: rgba(255,255,255,0.15);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
    }
    
    .control-btn:hover {
        background: rgba(255,255,255,0.25);
        transform: scale(1.1);
    }
    
    .control-btn:active {
        transform: scale(0.95);
    }
    
    .adblock-btn.active {
        background: #4CAF50;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .video-body { 
        width: 100%; 
        height: 100%; 
        background: #000; 
        flex: 1;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .video-body iframe, 
    .video-body video { 
        width: 100%; 
        height: 100%; 
        border: none; 
        display: block; 
    }
    
    .close-pinned-video { 
        background: #d9534f; 
        border: none; 
        color: white; 
        border-radius: 4px; 
        width: 28px; 
        height: 28px; 
        cursor: pointer; 
        font-size: 14px; 
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .close-pinned-video:hover {
        background: #c9302c;
        transform: scale(1.1);
    }
    
    .video-selector { 
        display: flex; 
        gap: 5px; 
        padding: 8px; 
        background: rgba(51, 122, 183, 0.1);
        border-top: 1px solid #eee;
        flex-shrink: 0; 
    }
    
    .video-selector button { 
        flex: 1; 
        padding: 6px 8px; 
        font-size: 11px; 
        background: #fff; 
        border: 1px solid #ddd; 
        border-radius: 4px; 
        cursor: pointer; 
        transition: all 0.2s ease;
    }
    
    .video-selector button:hover {
        background: #f0f0f0;
    }
    
    .video-selector button.active { 
        background: #337ab7; 
        color: white; 
        border-color: #2e6da4; 
    }
    
    /* Ù…Ù‚Ø§Ø¨Ø¶ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ± */
    .resize-handle {
        position: absolute;
        background: rgba(51, 122, 183, 0.8);
        border: 1px solid white;
        z-index: 1000;
        transition: all 0.2s ease;
    }
    
    .resize-handle:hover {
        background: rgba(51, 122, 183, 1);
    }
    
    .resize-handle.top-left { 
        top: -4px; 
        left: -4px; 
        width: 12px; 
        height: 12px; 
        cursor: nw-resize; 
        border-radius: 0 0 8px 0;
    }
    
    .resize-handle.top-right { 
        top: -4px; 
        right: -4px; 
        width: 12px; 
        height: 12px; 
        cursor: ne-resize; 
        border-radius: 0 0 0 8px;
    }
    
    .resize-handle.bottom-left { 
        bottom: -4px; 
        left: -4px; 
        width: 12px; 
        height: 12px; 
        cursor: sw-resize; 
        border-radius: 0 8px 0 0;
    }
    
    .resize-handle.bottom-right { 
        bottom: -4px; 
        right: -4px; 
        width: 12px; 
        height: 12px; 
        cursor: se-resize; 
        border-radius: 8px 0 0 0;
    }
    
    .resize-handle.top { 
        top: -4px; 
        left: 50%; 
        transform: translateX(-50%);
        width: 30px; 
        height: 6px; 
        cursor: n-resize; 
        border-radius: 3px;
    }
    
    .resize-handle.bottom { 
        bottom: -4px; 
        left: 50%; 
        transform: translateX(-50%);
        width: 30px; 
        height: 6px; 
        cursor: s-resize; 
        border-radius: 3px;
    }
    
    .resize-handle.left { 
        left: -4px; 
        top: 50%; 
        transform: translateY(-50%);
        width: 6px; 
        height: 30px; 
        cursor: w-resize; 
        border-radius: 3px;
    }
    
    .resize-handle.right { 
        right: -4px; 
        top: 50%; 
        transform: translateY(-50%);
        width: 6px; 
        height: 30px; 
        cursor: e-resize; 
        border-radius: 3px;
    }
    
    .ad-notification {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        z-index: 10000;
        font-size: 12px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    #adblockSettings {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 1004;
        display: none;
        width: 320px;
    }
    
    .setting-item {
        margin-bottom: 15px;
    }
    
    .setting-item label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .setting-item select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .stats {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        margin-top: 15px;
        border: 1px solid #e9ecef;
    }
    
    .stats p {
        margin: 5px 0;
        font-size: 13px;
    }
    
    #inputArea { position: fixed; bottom: 0; left: 0; right: 0; display: flex; align-items: center; gap: 8px; border-top: 1px solid #ddd; padding: 6px; background: #fafafa; z-index: 999; }
    #messageInput { flex: 1; font-size: 16px; padding: 8px; border: 1px solid #ccc; outline: none; direction: ltr; }
    #sendBtn { padding: 8px 12px; background: #f0f0f0; border: 1px solid #ccc; cursor: pointer; }
    .user-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .status-active { background-color: #28a745; }
    .status-idle { background-color: #ffc107; }
    .user-list-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }

    /* --- New Message Styles --- */
    #messages { overflow-y: auto; padding: 0; padding-bottom: 70px; background: #fff; direction: ltr; font-family: 'Tajawal', sans-serif; height: 100vh; box-sizing: border-box; }
    .hmsg { display: flex; outline: 1px solid lavender; width: 100%; }
    .u-pic { max-height: 52px !important; min-width: 52px; width: 52px; object-fit: cover; }
    .msg-content-fill { flex: 1; overflow: hidden; padding: 1px 1px 0 1px; }
    .msg-header { width: 100%; display: flex; height: 21px; align-items: center; justify-content: space-between; }
    .user-info-wrapper { display: flex; flex-grow: 1; overflow: hidden; }
    .u-topic { padding: 1px 4px; display: block; border-radius: 2px; background-color: rgb(240, 242, 245); color: #3366cc; font-weight: bold; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
    .tago { padding: 0px 2px; margin-left: 4px; color: grey; font-size: 11px; white-space: nowrap; }
    .u-msg { padding: 2px 1px 2px 5px; width: 100%; word-wrap: break-word; font-size: 15px; }
    .hmsg.notification { background-color: #f2f2f2; }
  </style>
</head>
<body>
    <div id="loginOverlay">
        <div id="loginBox">
            <ul class="nav-tabs">
                <li class="active"><a data-toggle="tab" href="#l1"><i class="fa fa-user"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²ÙˆØ§Ø±</a></li>
                <li><a data-toggle="tab" href="#l2"><i class="fa fa-user"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡</a></li>
                <li><a data-toggle="tab" href="#l3"><i class="fa fa-user-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶ÙˆÙŠÙ‡</a></li>
            </ul>
            <div class="tab-content">
                <div id="l1" class="tab-pane active">
                    <input type="text" id="visitorName" class="form-input" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±" required>
                    <button id="visitorBtn" class="form-submit-btn">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</button>
                </div>
                <div id="l2" class="tab-pane"><input type="text" id="loginName" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù…" required><input type="password" id="loginPassword" class="form-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required><button id="loginBtn" class="form-submit-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button></div>
                <div id="l3" class="tab-pane"><input type="text" id="registerName" class="form-input" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹" required><input type="password" id="registerPassword" class="form-input" placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" required><button id="registerBtn" class="form-submit-btn">ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button></div>
            </div>
            <div id="error-message"></div>
        </div>
    </div>
    <div id="chatContainer">
        <div id="topButtons">
            <div class="btn" id="setVideoBtn" title="ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ">ğŸ“º</div>
            <div class="btn" id="onlineListBtn" title="Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†">ğŸ‘¥ <span id="count" class="count-text">0</span></div>
            <div class="btn" id="settingsBtn" title="Ø§Ù„Ø¶Ø¨Ø·">âš™ï¸</div>
        </div>
        
        <!-- Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…ØªØ·ÙˆØ± -->
        <div id="pinnedVideoPlayer" class="video-player normal">
            <div class="video-header">
                <span>ğŸ¥ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</span>
                <div class="video-controls">
                    <button class="control-btn minimize" title="ØªØµØºÙŠØ±">ğŸ—•</button>
                    <button class="control-btn maximize" title="ØªÙƒØ¨ÙŠØ±">ğŸ—–</button>
                    <button class="control-btn adblock-btn" title="AdBlock">ğŸ›¡ï¸</button>
                    <button class="close-pinned-video">âœ•</button>
                </div>
            </div>
            <div class="video-body">
                <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
            <!-- Ù…Ù‚Ø§Ø¨Ø¶ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ± Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù‡Ø§Øª -->
            <div class="resize-handle top-left"></div>
            <div class="resize-handle top"></div>
            <div class="resize-handle top-right"></div>
            <div class="resize-handle left"></div>
            <div class="resize-handle right"></div>
            <div class="resize-handle bottom-left"></div>
            <div class="resize-handle bottom"></div>
            <div class="resize-handle bottom-right"></div>
        </div>
        
        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª AdBlock -->
        <div id="adblockSettings" class="settings-modal">
            <h4>ğŸ›¡ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¸Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h4>
            
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="blockVideoAds" checked>
                    Ø­Ø¸Ø± Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                </label>
            </div>
            
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="blockBannerAds" checked>
                    Ø­Ø¸Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
                </label>
            </div>
            
            <div class="setting-item">
                <label>Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¨Ù€:</label>
                <select id="adReplacement">
                    <option value="skip">ØªØ®Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
                    <option value="educational">Ù…Ø­ØªÙˆÙ‰ ØªØ¹Ù„ÙŠÙ…ÙŠ</option>
                    <option value="blank">Ø´Ø§Ø´Ø© Ø³ÙˆØ¯Ø§Ø¡</option>
                </select>
            </div>
            
            <div class="stats">
                <p>ğŸ“Š Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨Ø©: <span id="adsBlockedCount">0</span></p>
                <p>â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙÙˆÙØ±: <span id="timeSaved">0 Ø¯Ù‚ÙŠÙ‚Ø©</span></p>
            </div>
            
            <button id="saveAdblockSettings" style="width:100%;padding:10px;margin-top:10px;background:#337ab7;color:white;border:none;border-radius:6px;cursor:pointer;">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
        
        <div id="setVideoModal"><h4>ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¬Ù…ÙŠØ¹</h4><input type="text" id="videoUrlInput" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ ØªÙˆÙŠØªØ±ØŒ M3UØŒ Ø£Ùˆ MP4"/><button id="submitVideoUrlBtn">ØªØ«Ø¨ÙŠØª</button></div>
        <div id="usersBox"><h4>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</h4><div id="usersList"></div></div>
        <div id="editNameModal"><label for="newNameInput">ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label><input type="text" id="newNameInput" maxlength="20" /><button id="saveNameBtn">Ø­ÙØ¸</button></div>
        <div id="settingsModal">
            <h4>Ø§Ù„Ø¶Ø¨Ø·</h4>
            <ul class="settings-menu">
                <li><button id="settingsChangeAvatarBtn"><i class="fa fa-picture-o"></i> ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button></li>
                <li><button id="settingsChangeNameBtn"><i class="fa fa-pencil"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button></li>
                <li><button id="logoutBtn" class="logout"><i class="fa fa-sign-out"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></li>
            </ul>
        </div>
        <div id="overlay"></div><div id="messages"></div>
        <div id="inputArea"><input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." /><button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button></div>
        <input type="file" id="avatarInput" accept="image/*" style="display: none;" />
    </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDttyEjbuC6gzHxuN0IR8yi_9fO-aFyW64",
      authDomain: "studio-4914109762-6a41f.firebaseapp.com",
      projectId: "studio-4914109762-6a41f",
      storageBucket: "studio-4914109762-6a41f.firebasestorage.app",
      messagingSenderId: "134781295069",
      appId: "1:134781295069:web:3c020f46f8fbeaca24fe34"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.database();
    const loginOverlay = document.getElementById('loginOverlay'); const chatContainer = document.getElementById('chatContainer'); const errorMessage = document.getElementById('error-message');
    const tabs = document.querySelectorAll('.nav-tabs a'); const tabPanes = document.querySelectorAll('.tab-pane');
    tabs.forEach(tab => { tab.addEventListener('click', (e) => { e.preventDefault(); tabs.forEach(item => item.parentElement.classList.remove('active')); tab.parentElement.classList.add('active'); tabPanes.forEach(pane => pane.classList.remove('active')); document.querySelector(tab.getAttribute('href')).classList.add('active'); errorMessage.textContent = ''; }); });
    const registerBtn = document.getElementById('registerBtn'); const loginBtn = document.getElementById('loginBtn'); const visitorBtn = document.getElementById('visitorBtn');
    const createFakeEmail = (name) => `${name.toLowerCase().trim().replace(/\s+/g, '_')}@chat.local`;
    registerBtn.onclick = () => { const name = document.getElementById('registerName').value; const password = document.getElementById('registerPassword').value; if (!name || !password) { errorMessage.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; return; } const email = createFakeEmail(name); errorMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...'; auth.createUserWithEmailAndPassword(email, password).catch(error => { if (error.code === 'auth/email-already-in-use') { errorMessage.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.'; } else if (error.code === 'auth/weak-password') { errorMessage.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'; } else { errorMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.'; } }); };
    loginBtn.onclick = () => { const name = document.getElementById('loginName').value; const password = document.getElementById('loginPassword').value; if (!name || !password) { errorMessage.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; return; } const email = createFakeEmail(name); errorMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...'; auth.signInWithEmailAndPassword(email, password).catch(error => errorMessage.textContent = 'Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); };
    visitorBtn.onclick = () => { 
        const visitorName = document.getElementById('visitorName').value.trim();
        if (!visitorName) {
            errorMessage.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±.';
            return;
        }
        errorMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±...'; 
        auth.signInAnonymously().catch(error => errorMessage.textContent = error.message); 
    };

    let chatInitialized = false; let heartbeatInterval = null;
    auth.onAuthStateChanged(user => {
        if (user) {
            loginOverlay.style.display = 'none'; chatContainer.style.display = 'block';
            if (!chatInitialized) { initializeApp(user); chatInitialized = true; }
        } else {
            loginOverlay.style.display = 'flex'; chatContainer.style.display = 'none';
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            chatInitialized = false;
        }
    });

    function initializeApp(user) {
        const myUserRef = db.ref("online").push();
        const myUserId = myUserRef.key;
        myUserRef.onDisconnect().remove();
        const defaultAvatarUrl = "https://j.top4top.io/p_3599hmcgu1.png";
        let myAvatarUrl = localStorage.getItem('userAvatar') || defaultAvatarUrl;
        if (!localStorage.getItem('userAvatar')) { localStorage.setItem('userAvatar', defaultAvatarUrl); }
        let username;
        if (user.isAnonymous) {
            const visitorNameInput = document.getElementById('visitorName').value.trim();
            if (visitorNameInput) {
                username = visitorNameInput;
                localStorage.setItem('visitorName', username);
            } else {
                let savedVisitorName = localStorage.getItem('visitorName');
                if (savedVisitorName) { 
                    username = savedVisitorName; 
                } else { 
                    username = "Ø²Ø§Ø¦Ø±_" + Math.floor(Math.random() * 1000); 
                    localStorage.setItem('visitorName', username); 
                }
            }
        } else { 
            username = user.email.split('@')[0].replace(/_/g, ' '); 
        }
        myUserRef.set({ name: username, status: 'active', avatar: myAvatarUrl, last_seen: firebase.database.ServerValue.TIMESTAMP });
        heartbeatInterval = setInterval(() => { myUserRef.update({ last_seen: firebase.database.ServerValue.TIMESTAMP }); }, 60 * 1000);

        const onlineListBtn = document.getElementById("onlineListBtn"); 
        const setVideoBtn = document.getElementById("setVideoBtn"); 
        const settingsBtn = document.getElementById("settingsBtn"); 
        const settingsModal = document.getElementById("settingsModal"); 
        const settingsChangeAvatarBtn = document.getElementById("settingsChangeAvatarBtn"); 
        const settingsChangeNameBtn = document.getElementById("settingsChangeNameBtn"); 
        const logoutBtn = document.getElementById("logoutBtn"); 
        const avatarInput = document.getElementById("avatarInput"); 
        const usersBox = document.getElementById("usersBox"); 
        const usersList = document.getElementById("usersList"); 
        const overlay = document.getElementById("overlay"); 
        const count = document.getElementById("count"); 
        const messagesDiv = document.getElementById("messages"); 
        const messageInput = document.getElementById("messageInput"); 
        const sendBtn = document.getElementById("sendBtn"); 
        const editNameModal = document.getElementById("editNameModal"); 
        const newNameInput = document.getElementById("newNameInput"); 
        const saveNameBtn = document.getElementById("saveNameBtn"); 
        const setVideoModal = document.getElementById("setVideoModal"); 
        const videoUrlInput = document.getElementById("videoUrlInput"); 
        const submitVideoUrlBtn = document.getElementById("submitVideoUrlBtn"); 
        const pinnedVideoPlayer = document.getElementById("pinnedVideoPlayer");
        
        let onlineUsersCache = {}; let idleTimer; const IDLE_TIMEOUT = 2 * 60 * 1000;
        let initialUsersLoaded = false; 

        // Ù†Ø¸Ø§Ù… AdBlock Ø§Ù„Ù…ØªØ·ÙˆØ±
        class VideoAdBlocker {
            constructor() {
                this.adsBlocked = parseInt(localStorage.getItem('adsBlocked')) || 0;
                this.timeSaved = parseInt(localStorage.getItem('timeSaved')) || 0;
                this.isActive = localStorage.getItem('adblockActive') !== 'false';
                this.blockedDomains = [
                    'googlesyndication.com',
                    'doubleclick.net',
                    'googleadservices.com',
                    'adservice.google.com',
                    'youtube.com/api/stats/ads',
                    'pagead2.googlesyndication.com'
                ];
                this.setupAdBlocking();
                this.updateStats();
            }

            setupAdBlocking() {
                if (!this.isActive) return;

                // Ø­Ø¸Ø± Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
                const originalFetch = window.fetch;
                window.fetch = (...args) => {
                    const url = args[0];
                    if (this.isAdUrl(url)) {
                        this.blockAd();
                        return Promise.reject(new Error('Ad blocked'));
                    }
                    return originalFetch.apply(this, args);
                };

                // Ø§Ø¹ØªØ±Ø§Ø¶ XMLHttpRequest
                const originalXHR = window.XMLHttpRequest;
                window.XMLHttpRequest = function() {
                    const xhr = new originalXHR();
                    const originalOpen = xhr.open;
                    xhr.open = function(method, url) {
                        if (this.isAdUrl(url)) {
                            this.blockAd();
                            return;
                        }
                        return originalOpen.apply(this, arguments);
                    }.bind(this);
                    return xhr;
                }.bind(this);

                this.setupDOMMonitoring();
                this.setupYouTubeAdBlock();
            }

            isAdUrl(url) {
                if (!url) return false;
                return this.blockedDomains.some(domain => 
                    typeof url === 'string' && url.includes(domain)
                );
            }

            setupDOMMonitoring() {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) {
                                this.checkForAds(node);
                            }
                        });
                    });
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }

            setupYouTubeAdBlock() {
                // ÙƒØ´Ù ÙˆØ¥Ø²Ø§Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨
                setInterval(() => {
                    // Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    const videoAds = document.querySelector('.ad-showing, .ad-interrupting');
                    if (videoAds) {
                        const video = document.querySelector('video');
                        if (video) {
                            video.currentTime = video.duration;
                            this.blockAd();
                        }
                    }

                    // Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
                    const popupAds = document.querySelector('.ytp-ad-module, .ytp-ad-overlay-container');
                    if (popupAds) {
                        popupAds.remove();
                        this.blockAd();
                    }
                }, 1000);
            }

            checkForAds(element) {
                // ÙƒØ´Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©
                const adSelectors = [
                    '.ad', '[class*="ad-"]', '[id*="ad-"]',
                    '.advertisement', '.ad-container',
                    '.ytp-ad-module', '.ytp-ad-overlay-container'
                ];

                adSelectors.forEach(selector => {
                    const ads = element.querySelectorAll ? element.querySelectorAll(selector) : [];
                    ads.forEach(ad => {
                        ad.remove();
                        this.blockAd();
                    });
                });

                // ÙƒØ´Ù iframes Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©
                const iframes = element.querySelectorAll ? element.querySelectorAll('iframe') : [];
                iframes.forEach(iframe => {
                    try {
                        const src = iframe.src;
                        if (this.isAdUrl(src)) {
                            iframe.remove();
                            this.blockAd();
                        }
                    } catch (e) {}
                });
            }

            blockAd() {
                this.adsBlocked++;
                this.timeSaved += 0.5; // ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙÙˆÙØ±
                this.updateStats();
                this.showAdNotification();
            }

            updateStats() {
                document.getElementById('adsBlockedCount').textContent = this.adsBlocked;
                document.getElementById('timeSaved').textContent = Math.floor(this.timeSaved) + ' Ø¯Ù‚ÙŠÙ‚Ø©';
                
                // Ø­ÙØ¸ ÙÙŠ localStorage
                localStorage.setItem('adsBlocked', this.adsBlocked);
                localStorage.setItem('timeSaved', this.timeSaved);
            }

            showAdNotification() {
                const existingNotification = document.querySelector('.ad-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.className = 'ad-notification';
                notification.textContent = `ğŸ›¡ï¸ ØªÙ… Ø­Ø¸Ø± Ø¥Ø¹Ù„Ø§Ù† (${this.adsBlocked})`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }

            toggle() {
                this.isActive = !this.isActive;
                localStorage.setItem('adblockActive', this.isActive);
                
                const adblockBtn = document.querySelector('.adblock-btn');
                adblockBtn.classList.toggle('active', this.isActive);
                
                if (this.isActive) {
                    this.setupAdBlocking();
                }
            }
        }

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…ØªØ·ÙˆØ±
        class AdvancedVideoPlayer {
            constructor() {
                this.currentMode = 'normal';
                this.isDragging = false;
                this.isResizing = false;
                this.dragOffset = { x: 0, y: 0 };
                this.resizeData = null;
                this.setupEventListeners();
                this.updateControlButtons();
            }

            setupEventListeners() {
                const header = pinnedVideoPlayer.querySelector('.video-header');
                
                // Ø§Ù„Ø³Ø­Ø¨
                header.addEventListener('mousedown', this.startDrag.bind(this));
                header.addEventListener('touchstart', this.startDrag.bind(this));
                
                document.addEventListener('mousemove', this.drag.bind(this));
                document.addEventListener('touchmove', this.drag.bind(this));
                document.addEventListener('mouseup', this.stopDrag.bind(this));
                document.addEventListener('touchend', this.stopDrag.bind(this));

                // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø­Ø¬Ù…
                const minimizeBtn = pinnedVideoPlayer.querySelector('.minimize');
                const maximizeBtn = pinnedVideoPlayer.querySelector('.maximize');
                const adblockBtn = pinnedVideoPlayer.querySelector('.adblock-btn');
                const closeBtn = pinnedVideoPlayer.querySelector('.close-pinned-video');

                minimizeBtn.addEventListener('click', () => this.setMode('mini'));
                maximizeBtn.addEventListener('click', () => this.setMode('full'));
                adblockBtn.addEventListener('click', () => adBlocker.toggle());
                closeBtn.addEventListener('click', () => db.ref("pinned_video").remove());

                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª AdBlock
                const saveAdblockSettings = document.getElementById('saveAdblockSettings');
                saveAdblockSettings.addEventListener('click', () => {
                    document.getElementById('adblockSettings').style.display = 'none';
                    overlay.style.display = 'none';
                });

                // Ù…Ù‚Ø§Ø¨Ø¶ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ±
                this.setupResizeHandles();
            }

            setupResizeHandles() {
                const handles = pinnedVideoPlayer.querySelectorAll('.resize-handle');
                
                handles.forEach(handle => {
                    handle.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.startResize(e, handle.classList);
                    });
                    
                    handle.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.startResize(e, handle.classList);
                    });
                });

                document.addEventListener('mousemove', this.resize.bind(this));
                document.addEventListener('touchmove', this.resize.bind(this));
                document.addEventListener('mouseup', this.stopResize.bind(this));
                document.addEventListener('touchend', this.stopResize.bind(this));
            }

            startResize(e, classList) {
                this.isResizing = true;
                this.resizeData = {
                    startX: e.clientX || e.touches[0].clientX,
                    startY: e.clientY || e.touches[0].clientY,
                    startWidth: parseInt(getComputedStyle(pinnedVideoPlayer).width, 10),
                    startHeight: parseInt(getComputedStyle(pinnedVideoPlayer).height, 10),
                    startLeft: parseInt(getComputedStyle(pinnedVideoPlayer).left, 10),
                    startTop: parseInt(getComputedStyle(pinnedVideoPlayer).top, 10),
                    direction: this.getResizeDirection(classList)
                };
                
                pinnedVideoPlayer.style.transition = 'none';
                document.body.style.userSelect = 'none';
            }

            getResizeDirection(classList) {
                if (classList.contains('top-left')) return 'nw';
                if (classList.contains('top')) return 'n';
                if (classList.contains('top-right')) return 'ne';
                if (classList.contains('left')) return 'w';
                if (classList.contains('right')) return 'e';
                if (classList.contains('bottom-left')) return 'sw';
                if (classList.contains('bottom')) return 's';
                if (classList.contains('bottom-right')) return 'se';
                return 'se';
            }

            resize(e) {
                if (!this.isResizing || !this.resizeData) return;

                const currentX = e.clientX || (e.touches && e.touches[0].clientX);
                const currentY = e.clientY || (e.touches && e.touches[0].clientY);
                
                if (!currentX || !currentY) return;

                const deltaX = currentX - this.resizeData.startX;
                const deltaY = currentY - this.resizeData.startY;
                
                let newWidth = this.resizeData.startWidth;
                let newHeight = this.resizeData.startHeight;
                let newLeft = this.resizeData.startLeft;
                let newTop = this.resizeData.startTop;

                const minWidth = 320;
                const minHeight = 180;
                const maxWidth = window.innerWidth * 0.95;
                const maxHeight = window.innerHeight * 0.95;

                switch (this.resizeData.direction) {
                    case 'e':
                        newWidth = Math.min(maxWidth, Math.max(minWidth, this.resizeData.startWidth + deltaX));
                        break;
                    case 'w':
                        newWidth = Math.min(maxWidth, Math.max(minWidth, this.resizeData.startWidth - deltaX));
                        newLeft = this.resizeData.startLeft + deltaX;
                        break;
                    case 's':
                        newHeight = Math.min(maxHeight, Math.max(minHeight, this.resizeData.startHeight + deltaY));
                        break;
                    case 'n':
                        newHeight = Math.min(maxHeight, Math.max(minHeight, this.resizeData.startHeight - deltaY));
                        newTop = this.resizeData.startTop + deltaY;
                        break;
                    case 'se':
                        newWidth = Math.min(maxWidth, Math.max(minWidth, this.resizeData.startWidth + deltaX));
                        newHeight = Math.min(maxHeight, Math.max(minHeight, this.resizeData.startHeight + deltaY));
                        break;
                    case 'sw':
                        newWidth = Math.min(maxWidth, Math.max(minWidth, this.resizeData.startWidth - deltaX));
                        newHeight = Math.min(maxHeight, Math.max(minHeight, this.resizeData.startHeight + deltaY));
                        newLeft = this.resizeData.startLeft + deltaX;
                        break;
                    case 'ne':
                        newWidth = Math.min(maxWidth, Math.max(minWidth, this.resizeData.startWidth + deltaX));
                        newHeight = Math.min(maxHeight, Math.max(minHeight, this.resizeData.startHeight - deltaY));
                        newTop = this.resizeData.startTop + deltaY;
                        break;
                    case 'nw':
                        newWidth = Math.min(maxWidth, Math.max(minWidth, this.resizeData.startWidth - deltaX));
                        newHeight = Math.min(maxHeight, Math.max(minHeight, this.resizeData.startHeight - deltaY));
                        newLeft = this.resizeData.startLeft + deltaX;
                        newTop = this.resizeData.startTop + deltaY;
                        break;
                }

                pinnedVideoPlayer.style.width = newWidth + 'px';
                pinnedVideoPlayer.style.height = newHeight + 'px';
                
                if (newLeft !== this.resizeData.startLeft) {
                    pinnedVideoPlayer.style.left = newLeft + 'px';
                }
                if (newTop !== this.resizeData.startTop) {
                    pinnedVideoPlayer.style.top = newTop + 'px';
                }

                // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±ÙƒØ² Ø¹Ù†Ø¯ Ø§Ù„ØªÙƒØ¨ÙŠØ±
                if (this.currentMode === 'normal') {
                    this.currentMode = 'custom';
                    pinnedVideoPlayer.classList.remove('normal');
                    pinnedVideoPlayer.classList.add('custom');
                }
            }

            stopResize() {
                this.isResizing = false;
                this.resizeData = null;
                pinnedVideoPlayer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                document.body.style.userSelect = '';
            }

            startDrag(e) {
                if (this.isResizing) return;
                
                this.isDragging = true;
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                
                const rect = pinnedVideoPlayer.getBoundingClientRect();
                this.dragOffset.x = clientX - rect.left;
                this.dragOffset.y = clientY - rect.top;
                
                pinnedVideoPlayer.style.cursor = 'grabbing';
                pinnedVideoPlayer.style.transition = 'none';
                
                // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±ÙƒØ² Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨
                if (this.currentMode === 'normal') {
                    this.currentMode = 'custom';
                    pinnedVideoPlayer.classList.remove('normal');
                    pinnedVideoPlayer.classList.add('custom');
                }
            }

            drag(e) {
                if (!this.isDragging || this.isResizing) return;
                
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                if (!clientX || !clientY) return;

                if (this.currentMode !== 'full') {
                    const newX = clientX - this.dragOffset.x;
                    const newY = clientY - this.dragOffset.y;
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¶Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
                    const maxX = window.innerWidth - pinnedVideoPlayer.offsetWidth;
                    const maxY = window.innerHeight - pinnedVideoPlayer.offsetHeight;
                    
                    pinnedVideoPlayer.style.left = Math.max(0, Math.min(maxX, newX)) + 'px';
                    pinnedVideoPlayer.style.top = Math.max(0, Math.min(maxY, newY)) + 'px';
                    pinnedVideoPlayer.style.transform = 'none';
                }
            }

            stopDrag() {
                this.isDragging = false;
                pinnedVideoPlayer.style.cursor = 'grab';
                pinnedVideoPlayer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            }

            setMode(mode) {
                this.currentMode = mode;
                pinnedVideoPlayer.className = `video-player ${mode}`;
                this.updateControlButtons();
            }

            updateControlButtons() {
                const minimizeBtn = pinnedVideoPlayer.querySelector('.minimize');
                const maximizeBtn = pinnedVideoPlayer.querySelector('.maximize');
                
                minimizeBtn.style.opacity = this.currentMode === 'mini' ? '0.5' : '1';
                maximizeBtn.style.opacity = this.currentMode === 'full' ? '0.5' : '1';
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
        const adBlocker = new VideoAdBlocker();
        let videoPlayer = new AdvancedVideoPlayer();

        // ÙˆØ¸ÙŠÙØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function loadInitialMessages() {
            messagesDiv.innerHTML = '';
            
            db.ref("messages")
                .limitToLast(30)
                .on("child_added", (snap) => { 
                    const msg = snap.val(); 
                    addMessage(msg.user, msg.text, msg.time, msg.avatar); 
                });
        }

        function addMessage(user, text, time, avatarUrl) {
            const div = document.createElement("div");
            div.className = "hmsg";
            const effectiveAvatar = avatarUrl || defaultAvatarUrl;
            div.innerHTML = `
                <img class="u-pic" src="${effectiveAvatar}">
                <div class="msg-content-fill">
                    <div class="msg-header">
                        <div class="user-info-wrapper">
                            <span class="u-topic">${user}</span>
                        </div>
                        <span class="tago">(${time})</span>
                    </div>
                    <div class="u-msg">${text}</div>
                </div>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addNotification(user, text, avatarUrl) {
            const div = document.createElement("div");
            div.className = "hmsg notification";
            const effectiveAvatar = avatarUrl || defaultAvatarUrl;
            const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
            div.innerHTML = `
                <img class="u-pic" src="${effectiveAvatar}">
                <div class="msg-content-fill">
                    <div class="msg-header">
                        <div class="user-info-wrapper">
                            <span class="u-topic">${user}</span>
                        </div>
                        <span class="tago">(${time})</span>
                    </div>
                    <div class="u-msg">${text}</div>
                </div>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function closeAllModals() { 
            usersBox.style.display = 'none'; 
            editNameModal.style.display = 'none'; 
            setVideoModal.style.display = 'none'; 
            settingsModal.style.display = 'none'; 
            document.getElementById('adblockSettings').style.display = 'none';
            overlay.style.display = 'none'; 
        }
        
        onlineListBtn.onclick = () => { usersBox.style.display = 'block'; overlay.style.display = 'block'; };
        setVideoBtn.onclick = () => { setVideoModal.style.display = 'block'; overlay.style.display = 'block'; };
        settingsBtn.onclick = () => { settingsModal.style.display = 'block'; overlay.style.display = 'block'; };
        settingsChangeNameBtn.onclick = () => { closeAllModals(); editNameModal.style.display = 'block'; overlay.style.display = 'block'; newNameInput.value = username; newNameInput.focus(); };
        settingsChangeAvatarBtn.onclick = () => { avatarInput.click(); closeAllModals(); };
        
        logoutBtn.onclick = () => {
            closeAllModals();
            myUserRef.remove();
            auth.signOut();
        };

        overlay.onclick = closeAllModals;
        sendBtn.onclick = sendMessage;
        messageInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
        saveNameBtn.onclick = () => { const newName = newNameInput.value.trim(); if (!newName) return; updateUsername(newName); closeAllModals(); };
        avatarInput.onchange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = () => { const base64String = reader.result; myAvatarUrl = base64String; localStorage.setItem('userAvatar', base64String); myUserRef.update({ avatar: base64String }); addNotification(username, "âœ… ØªÙ… ØªØºÙŠÙŠØ± ØµÙˆØ±ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­.", myAvatarUrl); }; reader.readAsDataURL(file); };
        
        function updateMyStatus(newStatus) { myUserRef.child('status').once('value', (snapshot) => { if (snapshot.val() !== newStatus) { myUserRef.update({ status: newStatus }); } }); }
        function resetIdleTimer() { clearTimeout(idleTimer); updateMyStatus('active'); idleTimer = setTimeout(() => { updateMyStatus('idle'); }, IDLE_TIMEOUT); }
        document.addEventListener('mousemove', resetIdleTimer); document.addEventListener('keypress', resetIdleTimer); messageInput.addEventListener('input', resetIdleTimer); resetIdleTimer();
        
        function getYoutubeVideoId(url) { if (!url) return null; const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/; return (url.match(regex) || [])[1] || null; }
        function getTweetId(url) { if (!url) return null; const regex = /(?:https?:\/\/)?(?:www\.)?(?:twitter|x)\.com\/(?:\w+)\/status\/(\d+)/; return (url.match(regex) || [])[1] || null; }
        function isDirectVideo(url) { return /\.(mp4|webm|ogv)$/.test(url); }
        function updateUsername(newName) { if (!newName || newName === username) return; username = newName; myUserRef.update({ name: newName }); }
        function sendMessage() { const text = messageInput.value.trim(); if (!text) return; const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }); db.ref("messages").push().set({ user: username, text, time, avatar: myAvatarUrl }); messageInput.value = ""; }
        submitVideoUrlBtn.onclick = () => { const url = videoUrlInput.value.trim(); if (!url) return; const youtubeId = getYoutubeVideoId(url); const tweetId = getTweetId(url); if (youtubeId) { db.ref("pinned_video").set({ type: 'youtube', id: youtubeId, setBy: username }); } else if (tweetId) { db.ref("pinned_video").set({ type: 'twitter', id: tweetId, setBy: username }); } else if (url.toLowerCase().includes('.m3u')) { db.ref("pinned_video").set({ type: 'm3u', url: url, setBy: username }); } else if (isDirectVideo(url)) { db.ref("pinned_video").set({ type: 'direct', url: url, setBy: username }); } else { alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…."); return; } closeAllModals(); };
        
        db.ref("online").on("value", (snap) => {
            const newUsersObject = snap.val() || {};
            const GHOST_TIMEOUT = 5 * 60 * 1000;
            Object.entries(newUsersObject).forEach(([key, userData]) => { if (Date.now() - userData.last_seen > GHOST_TIMEOUT) { db.ref(`online/${key}`).remove(); } });
            
            if (initialUsersLoaded) {
                Object.keys(onlineUsersCache).forEach(userId => { if (!newUsersObject[userId]) { addNotification(onlineUsersCache[userId].name, 'ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©', onlineUsersCache[userId].avatar); } });
                Object.keys(newUsersObject).forEach(userId => {
                    if (!onlineUsersCache[userId] && userId !== myUserId) { addNotification(newUsersObject[userId].name, 'Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©', newUsersObject[userId].avatar); }
                    else if (onlineUsersCache[userId] && newUsersObject[userId].name !== onlineUsersCache[userId].name) { addNotification(newUsersObject[userId].name, `âœï¸ ØºÙŠØ± Ø§Ø³Ù…Ù‡ Ù…Ù† ${onlineUsersCache[userId].name}`, newUsersObject[userId].avatar); }
                });
            }

            const newUsersArray = Object.entries(newUsersObject);
            usersList.innerHTML = "";
            newUsersArray.forEach(([key, user]) => { const userItem = document.createElement("div"); userItem.className = "user-item"; const avatarImg = document.createElement("img"); avatarImg.src = user.avatar || defaultAvatarUrl; avatarImg.className = 'user-list-avatar'; const statusDot = document.createElement("div"); statusDot.className = `status-dot ${user.status === 'active' ? 'status-active' : 'status-idle'}`; const nameSpan = document.createElement("span"); nameSpan.textContent = user.name; userItem.appendChild(avatarImg); userItem.appendChild(statusDot); userItem.appendChild(nameSpan); usersList.appendChild(userItem); });
            count.textContent = newUsersArray.length;
            
            onlineUsersCache = newUsersObject;
            initialUsersLoaded = true;
        });

        // Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        loadInitialMessages();

        // Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø¯Ø¹Ù… ØªÙˆÙŠØªØ± Ø§Ù„ÙƒØ§Ù…Ù„
        db.ref("pinned_video").on("value", async (snap) => { 
            const data = snap.val(); 
            
            if (data) { 
                pinnedVideoPlayer.style.display = 'flex'; 
                const body = pinnedVideoPlayer.querySelector('.video-body');
                body.innerHTML = '';
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø´ØºÙ„
                videoPlayer = new AdvancedVideoPlayer();

                const createAndAppendVideo = (src, aspectRatio = "16 / 9") => { 
                    const video = document.createElement('video'); 
                    video.src = src; 
                    video.controls = true; 
                    video.autoplay = true; 
                    video.muted = true; 
                    video.style.aspectRatio = aspectRatio; 
                    video.setAttribute('playsinline', ''); 
                    body.appendChild(video); 
                    return video; 
                }; 

                if (data.type === 'youtube') { 
                    body.innerHTML = `<iframe src="https://www.youtube.com/embed/${data.id}?autoplay=1&mute=1" allow="autoplay; encrypted-media" allowfullscreen style="aspect-ratio: 16 / 9; width: 100%; height: 100%;"></iframe>`; 
                } else if (data.type === 'm3u' || data.type === 'direct') { 
                    createAndAppendVideo(data.url); 
                } else if (data.type === 'twitter') { 
                    try { 
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Twitter Widgets API
                        body.innerHTML = `<blockquote class="twitter-tweet" data-lang="ar"><a href="https://twitter.com/i/status/${data.id}"></a></blockquote>`;
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Twitter Widgets
                        if (window.twttr && window.twttr.widgets) {
                            window.twttr.widgets.load(body);
                        }
                        
                    } catch (error) { 
                        console.error("Error loading Twitter video:", error); 
                        body.innerHTML = `<p style="color:white;padding:10px;text-align:center;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù‚Ø·Ø¹ ØªÙˆÙŠØªØ±</p>`; 
                    } 
                } 
                
                if (initialUsersLoaded && data) { 
                    const setterName = data.setBy; 
                    let setterAvatar = defaultAvatarUrl; 
                    const setter = Object.values(onlineUsersCache).find(u => u.name === setterName); 
                    if (setter) { setterAvatar = setter.avatar; } 
                    addNotification(setterName, 'ğŸ“º Ù‚Ø§Ù… Ø¨ØªØ´ØºÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯', setterAvatar); 
                } 
            } else { 
                pinnedVideoPlayer.style.display = 'none'; 
            } 
        });
    }
  </script>
</body>
</html>
