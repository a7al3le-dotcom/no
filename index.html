<!DOCTYPE html>
<html lang="ar" hreflang="ar-sa" style="height: 100%;">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <title>Ø´Ø§Øª Ù†ÙˆÙ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  <style>
    body { margin: 0; font-family: 'Tajawal', sans-serif; overflow: hidden; background-color: #f0f2f5; }
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; z-index: 2000; direction: rtl; }
    #loginBox { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 100%; max-width: 400px; }
    .nav-tabs { display: flex; list-style: none; padding: 0; margin: 0; border-bottom: 1px solid #ddd; }
    .nav-tabs li { flex: 1; text-align: center; }
    .nav-tabs li a { display: block; padding: 12px 6px; text-decoration: none; color: #555; background-color: #f7f7f7; border: 1px solid transparent; border-bottom: none; }
    .nav-tabs li.active a { background-color: #fff; border-color: #ddd; border-bottom-color: transparent; border-top-left-radius: 8px; border-top-right-radius: 8px; position: relative; top: 1px; }
    .tab-content { padding: 25px; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .form-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
    .form-submit-btn { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; color: #333; font-size: 16px; cursor: pointer; background-color: #f0f0f0; transition: background-color 0.2s; font-weight: bold; }
    .form-submit-btn:hover { background-color: #e0e0e0; }
    #error-message { color: #fa3e3e; margin-top: 15px; font-size: 14px; height: 20px; text-align: center; }
    #chatContainer { display: none; height: 100vh; position: relative; }
    #topButtons { position: fixed; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000; }
    .btn { padding: 6px 10px; background: white; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; font-size: 16px; line-height: 1; display: flex; align-items: center; }
    .btn .count-text { font-size: 14px; margin-right: 4px; }
    #usersBox, #editNameModal, #setVideoModal, #settingsModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1003; display: none; }
    #usersList { max-height: 200px; overflow-y: auto; }
    #settingsModal { width: 250px; }
    .settings-menu { list-style: none; padding: 0; margin: 0; }
    .settings-menu li { margin-bottom: 10px; }
    .settings-menu button { width: 100%; padding: 12px; text-align: right; font-size: 15px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .settings-menu button:hover { background-color: #e9e9e9; }
    .settings-menu button.logout { color: #d9534f; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; }
    #pinnedVideoPlayer { position: fixed; top: 50px; left: 50px; width: clamp(300px, 90vw, 450px); background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 998; display: none; flex-direction: column; }
    .video-header { background-color: #337ab7; color: white; padding: 5px 10px; border-top-left-radius: 7px; border-top-right-radius: 7px; cursor: move; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; touch-action: none; }
    .video-body { width: 100%; background: #000; }
    .video-body iframe, .video-body video { width: 100%; height: 100%; border: none; display: block; }
    .close-pinned-video { background: #d9534f; border: 1px solid #d43f3a; color: white; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 14px; line-height: 20px; text-align: center; }
    .video-selector { display: flex; gap: 5px; padding: 5px; background: #e9ecef; border-bottom-left-radius: 7px; border-bottom-right-radius: 7px; flex-shrink: 0; }
    .video-selector button { flex: 1; padding: 5px; font-size: 12px; background: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
    .video-selector button.active { background-color: #337ab7; color: white; border-color: #2e6da4; }
    #messages { overflow-y: auto; padding: 10px; padding-bottom: 70px; background: #fff; direction: rtl; font-family: 'Tajawal', sans-serif; height: 100vh; box-sizing: border-box; }
    .msg { display: flex; gap: 10px; align-items: flex-start; margin: 8px 0; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; font-size: 15px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; object-fit: cover; }
    .msg-content { display: flex; flex-direction: column; flex-grow: 1; }
    .msg-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .msg-text { word-wrap: break-word; }
    .sys { text-align: center; color: gray; font-size: 12px; margin: 5px 0; }
    .user { font-weight: bold; color: #3366cc; }
    .time { font-size: 11px; color: gray; }
    #inputArea { position: fixed; bottom: 0; left: 0; right: 0; display: flex; align-items: center; gap: 8px; border-top: 1px solid #ddd; padding: 6px; background: #fafafa; z-index: 999; }
    #messageInput { flex: 1; font-size: 16px; padding: 8px; border: 1px solid #ccc; outline: none; direction: rtl; }
    #sendBtn { padding: 8px 12px; background: #f0f0f0; border: 1px solid #ccc; cursor: pointer; }
    .user-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .status-active { background-color: #28a745; }
    .status-idle { background-color: #ffc107; }
    .user-list-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    .msg.notification .msg-content { justify-content: center; }
    .notification-text { font-style: italic; color: #888; }
    .notification-text .user { color: #555; font-weight: bold; }
  </style>
</head>
<body>
    <div id="loginOverlay">
        <div id="loginBox">
            <ul class="nav nav-tabs">
                <li><a data-toggle="tab" href="#l1"><i class="fa fa-user"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²ÙˆØ§Ø±</a></li>
                <li class="active"><a data-toggle="tab" href="#l2"><i class="fa fa-user"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡</a></li>
                <li><a data-toggle="tab" href="#l3"><i class="fa fa-user-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶ÙˆÙŠÙ‡</a></li>
            </ul>
            <div class="tab-content">
                <div id="l1" class="tab-pane"><p style="margin-top: 10px; margin-bottom: 20px; color: #555;">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø± ÙŠÙ…Ù†Ø­Ùƒ Ø§Ø³Ù…Ø§Ù‹ Ù…Ø¤Ù‚ØªØ§Ù‹.</p><button id="visitorBtn" class="form-submit-btn">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</button></div>
                <div id="l2" class="tab-pane active"><input type="text" id="loginName" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù…" required><input type="password" id="loginPassword" class="form-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required><button id="loginBtn" class="form-submit-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button></div>
                <div id="l3" class="tab-pane"><input type="text" id="registerName" class="form-input" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹" required><input type="password" id="registerPassword" class="form-input" placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" required><button id="registerBtn" class="form-submit-btn">ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button></div>
            </div>
            <div id="error-message"></div>
        </div>
    </div>
    <div id="chatContainer">
        <div id="topButtons">
            <div class="btn" id="setVideoBtn" title="ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ">ğŸ“º</div>
            <div class="btn" id="onlineListBtn" title="Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†">ğŸ‘¥ <span id="count" class="count-text">0</span></div>
            <div class="btn" id="settingsBtn" title="Ø§Ù„Ø¶Ø¨Ø·">âš™ï¸</div>
        </div>
        <div id="pinnedVideoPlayer"></div>
        <div id="setVideoModal"><h4>ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¬Ù…ÙŠØ¹</h4><input type="text" id="videoUrlInput" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ ØªÙˆÙŠØªØ±ØŒ M3UØŒ Ø£Ùˆ MP4"/><button id="submitVideoUrlBtn">ØªØ«Ø¨ÙŠØª</button></div>
        <div id="usersBox"><h4>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</h4><div id="usersList"></div></div>
        <div id="editNameModal"><label for="newNameInput">ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label><input type="text" id="newNameInput" maxlength="20" /><button id="saveNameBtn">Ø­ÙØ¸</button></div>
        <div id="settingsModal">
            <h4>Ø§Ù„Ø¶Ø¨Ø·</h4>
            <ul class="settings-menu">
                <li><button id="settingsChangeAvatarBtn"><i class="fa fa-picture-o"></i> ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button></li>
                <li><button id="settingsChangeNameBtn"><i class="fa fa-pencil"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button></li>
                <li><button id="logoutBtn" class="logout"><i class="fa fa-sign-out"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></li>
            </ul>
        </div>
        <div id="overlay"></div><div id="messages"></div>
        <div id="inputArea"><input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." /><button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button></div>
        <input type="file" id="avatarInput" accept="image/*" style="display: none;" />
    </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDttyEjbuC6gzHxuN0IR8yi_9fO-aFyW64",
      authDomain: "studio-4914109762-6a41f.firebaseapp.com",
      projectId: "studio-4914109762-6a41f",
      storageBucket: "studio-4914109762-6a41f.firebasestorage.app",
      messagingSenderId: "134781295069",
      appId: "1:134781295069:web:3c020f46f8fbeaca24fe34"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.database();
    const loginOverlay = document.getElementById('loginOverlay'); const chatContainer = document.getElementById('chatContainer'); const errorMessage = document.getElementById('error-message');
    const tabs = document.querySelectorAll('.nav-tabs a'); const tabPanes = document.querySelectorAll('.tab-pane');
    tabs.forEach(tab => { tab.addEventListener('click', (e) => { e.preventDefault(); tabs.forEach(item => item.parentElement.classList.remove('active')); tab.parentElement.classList.add('active'); tabPanes.forEach(pane => pane.classList.remove('active')); document.querySelector(tab.getAttribute('href')).classList.add('active'); errorMessage.textContent = ''; }); });
    const registerBtn = document.getElementById('registerBtn'); const loginBtn = document.getElementById('loginBtn'); const visitorBtn = document.getElementById('visitorBtn');
    const createFakeEmail = (name) => `${name.toLowerCase().trim().replace(/\s+/g, '_')}@chat.local`;
    registerBtn.onclick = () => { const name = document.getElementById('registerName').value; const password = document.getElementById('registerPassword').value; if (!name || !password) { errorMessage.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; return; } const email = createFakeEmail(name); errorMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...'; auth.createUserWithEmailAndPassword(email, password).catch(error => { if (error.code === 'auth/email-already-in-use') { errorMessage.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.'; } else if (error.code === 'auth/weak-password') { errorMessage.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'; } else { errorMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.'; } }); };
    loginBtn.onclick = () => { const name = document.getElementById('loginName').value; const password = document.getElementById('loginPassword').value; if (!name || !password) { errorMessage.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; return; } const email = createFakeEmail(name); errorMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...'; auth.signInWithEmailAndPassword(email, password).catch(error => errorMessage.textContent = 'Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); };
    visitorBtn.onclick = () => { errorMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±...'; auth.signInAnonymously().catch(error => errorMessage.textContent = error.message); };

    let chatInitialized = false; let heartbeatInterval = null;
    auth.onAuthStateChanged(user => {
        if (user) {
            loginOverlay.style.display = 'none'; chatContainer.style.display = 'block';
            if (!chatInitialized) { initializeApp(user); chatInitialized = true; }
        } else {
            loginOverlay.style.display = 'flex'; chatContainer.style.display = 'none';
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            chatInitialized = false;
        }
    });

    function initializeApp(user) {
        const myUserRef = db.ref("online").push();
        const myUserId = myUserRef.key;
        myUserRef.onDisconnect().remove();
        const defaultAvatarUrl = "https://j.top4top.io/p_3599hmcgu1.png";
        let myAvatarUrl = localStorage.getItem('userAvatar') || defaultAvatarUrl;
        if (!localStorage.getItem('userAvatar')) { localStorage.setItem('userAvatar', defaultAvatarUrl); }
        let username;
        if (user.isAnonymous) {
            let savedVisitorName = localStorage.getItem('visitorName');
            if (savedVisitorName) { username = savedVisitorName; }
            else { let newVisitorName = "Ø²Ø§Ø¦Ø±_" + Math.floor(Math.random() * 1000); localStorage.setItem('visitorName', newVisitorName); username = newVisitorName; }
        } else { username = user.email.split('@')[0].replace(/_/g, ' '); }
        myUserRef.set({ name: username, status: 'active', avatar: myAvatarUrl, last_seen: firebase.database.ServerValue.TIMESTAMP });
        heartbeatInterval = setInterval(() => { myUserRef.update({ last_seen: firebase.database.ServerValue.TIMESTAMP }); }, 60 * 1000);

        const onlineListBtn = document.getElementById("onlineListBtn"); const setVideoBtn = document.getElementById("setVideoBtn"); const settingsBtn = document.getElementById("settingsBtn"); const settingsModal = document.getElementById("settingsModal"); const settingsChangeAvatarBtn = document.getElementById("settingsChangeAvatarBtn"); const settingsChangeNameBtn = document.getElementById("settingsChangeNameBtn"); const logoutBtn = document.getElementById("logoutBtn"); const avatarInput = document.getElementById("avatarInput"); const usersBox = document.getElementById("usersBox"); const usersList = document.getElementById("usersList"); const overlay = document.getElementById("overlay"); const count = document.getElementById("count"); const messagesDiv = document.getElementById("messages"); const messageInput = document.getElementById("messageInput"); const sendBtn = document.getElementById("sendBtn"); const editNameModal = document.getElementById("editNameModal"); const newNameInput = document.getElementById("newNameInput"); const saveNameBtn = document.getElementById("saveNameBtn"); const setVideoModal = document.getElementById("setVideoModal"); const videoUrlInput = document.getElementById("videoUrlInput"); const submitVideoUrlBtn = document.getElementById("submitVideoUrlBtn"); const pinnedVideoPlayer = document.getElementById("pinnedVideoPlayer");
        let onlineUsersCache = {}; let idleTimer; const IDLE_TIMEOUT = 2 * 60 * 1000;

        function addMessage(user, text, time, avatarUrl) { const div = document.createElement("div"); div.className = "msg"; const effectiveAvatar = avatarUrl || defaultAvatarUrl; div.innerHTML = `<img src="${effectiveAvatar}" alt="Avatar" class="avatar"><div class="msg-content"><div class="msg-header"><span class="user">${user}:</span><span class="time">(${time})</span></div><div class="msg-text">${text}</div></div>`; messagesDiv.appendChild(div); messagesDiv.scrollTop = messagesDiv.scrollHeight; }
        function addNotificationMessage(userData, type) { const div = document.createElement("div"); div.className = "msg notification"; const effectiveAvatar = userData.avatar || defaultAvatarUrl; let textContent = type === 'joined' ? `<span class="user">${userData.name}</span> Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©` : `<span class="user">${userData.name}</span> ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©`; div.innerHTML = `<img src="${effectiveAvatar}" alt="Avatar" class="avatar"><div class="msg-content"><div class="notification-text">${textContent}</div></div>`; messagesDiv.appendChild(div); messagesDiv.scrollTop = messagesDiv.scrollHeight; }
        function showSystemMsg(text) { const div = document.createElement("div"); div.className = "sys"; div.textContent = text; messagesDiv.appendChild(div); messagesDiv.scrollTop = messagesDiv.scrollHeight; }
        function closeAllModals() { usersBox.style.display = 'none'; editNameModal.style.display = 'none'; setVideoModal.style.display = 'none'; settingsModal.style.display = 'none'; overlay.style.display = 'none'; }
        
        onlineListBtn.onclick = () => { usersBox.style.display = 'block'; overlay.style.display = 'block'; };
        setVideoBtn.onclick = () => { setVideoModal.style.display = 'block'; overlay.style.display = 'block'; };
        settingsBtn.onclick = () => { settingsModal.style.display = 'block'; overlay.style.display = 'block'; };
        settingsChangeNameBtn.onclick = () => { closeAllModals(); editNameModal.style.display = 'block'; overlay.style.display = 'block'; newNameInput.value = username; newNameInput.focus(); };
        settingsChangeAvatarBtn.onclick = () => { avatarInput.click(); closeAllModals(); };
        logoutBtn.onclick = () => { closeAllModals(); auth.signOut(); };
        overlay.onclick = closeAllModals;
        sendBtn.onclick = sendMessage;
        messageInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
        saveNameBtn.onclick = () => { const newName = newNameInput.value.trim(); if (!newName) return; updateUsername(newName); closeAllModals(); };
        avatarInput.onchange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = () => { const base64String = reader.result; myAvatarUrl = base64String; localStorage.setItem('userAvatar', base64String); myUserRef.update({ avatar: base64String }); showSystemMsg("âœ… ØªÙ… ØªØºÙŠÙŠØ± ØµÙˆØ±ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­."); }; reader.readAsDataURL(file); };
        
        function updateMyStatus(newStatus) { myUserRef.child('status').once('value', (snapshot) => { if (snapshot.val() !== newStatus) { myUserRef.update({ status: newStatus }); } }); }
        function resetIdleTimer() { clearTimeout(idleTimer); updateMyStatus('active'); idleTimer = setTimeout(() => { updateMyStatus('idle'); }, IDLE_TIMEOUT); }
        document.addEventListener('mousemove', resetIdleTimer); document.addEventListener('keypress', resetIdleTimer); messageInput.addEventListener('input', resetIdleTimer); resetIdleTimer();
        function makeDraggable(element, handle) { let offsetX = 0, offsetY = 0; let isDragging = false; const getPointerPosition = (e) => e.touches ? e.touches[0] : e; const onDragStart = (e) => { isDragging = true; const pointer = getPointerPosition(e); offsetX = pointer.clientX - element.offsetLeft; offsetY = pointer.clientY - element.offsetTop; document.addEventListener('mousemove', onDragMove); document.addEventListener('touchmove', onDragMove, { passive: false }); document.addEventListener('mouseup', onDragEnd); document.addEventListener('touchend', onDragEnd); }; const onDragMove = (e) => { if (isDragging) { e.preventDefault(); const pointer = getPointerPosition(e); element.style.left = (pointer.clientX - offsetX) + "px"; element.style.top = (pointer.clientY - offsetY) + "px"; } }; const onDragEnd = () => { isDragging = false; document.removeEventListener('mousemove', onDragMove); document.removeEventListener('touchmove', onDragMove); document.removeEventListener('mouseup', onDragEnd); document.removeEventListener('touchend', onDragEnd); }; handle.addEventListener('mousedown', onDragStart); handle.addEventListener('touchstart', onDragStart, { passive: false }); }
        function getYoutubeVideoId(url) { if (!url) return null; const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/; return (url.match(regex) || [])[1] || null; }
        function getTweetId(url) { if (!url) return null; const regex = /(?:https?:\/\/)?(?:www\.)?(?:twitter|x)\.com\/(?:\w+)\/status\/(\d+)/; return (url.match(regex) || [])[1] || null; }
        function isDirectVideo(url) { return /\.(mp4|webm|ogv)$/.test(url); }
        function updateUsername(newName) { if (!newName || newName === username) return; username = newName; myUserRef.update({ name: newName }); }
        function sendMessage() { const text = messageInput.value.trim(); if (!text) return; const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }); db.ref("messages").push().set({ user: username, text, time, avatar: myAvatarUrl }); messageInput.value = ""; }
        submitVideoUrlBtn.onclick = () => { const url = videoUrlInput.value.trim(); if (!url) return; const youtubeId = getYoutubeVideoId(url); const tweetId = getTweetId(url); if (youtubeId) { db.ref("pinned_video").set({ type: 'youtube', id: youtubeId, setBy: username }); } else if (tweetId) { db.ref("pinned_video").set({ type: 'twitter', id: tweetId, setBy: username }); } else if (url.toLowerCase().includes('.m3u')) { db.ref("pinned_video").set({ type: 'm3u', url: url, setBy: username }); } else if (isDirectVideo(url)) { db.ref("pinned_video").set({ type: 'direct', url: url, setBy: username }); } else { alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…."); return; } closeAllModals(); };
        
        db.ref("online").on("value", (snap) => {
            const newUsersObject = snap.val() || {};
            const GHOST_TIMEOUT = 5 * 60 * 1000;
            Object.entries(newUsersObject).forEach(([key, userData]) => { if (Date.now() - userData.last_seen > GHOST_TIMEOUT) { db.ref(`online/${key}`).remove(); } });
            
            Object.keys(onlineUsersCache).forEach(userId => { if (!newUsersObject[userId]) { addNotificationMessage(onlineUsersCache[userId], 'left'); } });
            Object.keys(newUsersObject).forEach(userId => {
                if (!onlineUsersCache[userId] && userId !== myUserId) { addNotificationMessage(newUsersObject[userId], 'joined'); }
                else if (onlineUsersCache[userId] && newUsersObject[userId].name !== onlineUsersCache[userId].name) { showSystemMsg(`âœï¸ ${onlineUsersCache[userId].name} ØºÙŠØ± Ø§Ø³Ù…Ù‡ Ø¥Ù„Ù‰ ${newUsersObject[userId].name}`); }
            });

            const newUsersArray = Object.entries(newUsersObject);
            usersList.innerHTML = "";
            newUsersArray.forEach(([key, user]) => { const userItem = document.createElement("div"); userItem.className = "user-item"; const avatarImg = document.createElement("img"); avatarImg.src = user.avatar || defaultAvatarUrl; avatarImg.className = 'user-list-avatar'; const statusDot = document.createElement("div"); statusDot.className = `status-dot ${user.status === 'active' ? 'status-active' : 'status-idle'}`; const nameSpan = document.createElement("span"); nameSpan.textContent = user.name; userItem.appendChild(avatarImg); userItem.appendChild(statusDot); userItem.appendChild(nameSpan); usersList.appendChild(userItem); });
            count.textContent = newUsersArray.length;
            onlineUsersCache = newUsersObject;
        });

        db.ref("messages").limitToLast(50).on("child_added", (snap) => { const msg = snap.val(); addMessage(msg.user, msg.text, msg.time, msg.avatar); });
        db.ref("pinned_video").on("value", async (snap) => { const data = snap.val(); pinnedVideoPlayer.innerHTML = ''; if (data) { pinnedVideoPlayer.style.display = 'flex'; const header = document.createElement('div'); header.className = 'video-header'; header.innerHTML = `<span>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</span>`; const closeBtn = document.createElement('button'); closeBtn.className = 'close-pinned-video'; closeBtn.innerHTML = 'âœ–'; closeBtn.onclick = () => db.ref("pinned_video").remove(); header.appendChild(closeBtn); const body = document.createElement('div'); body.className = 'video-body'; pinnedVideoPlayer.appendChild(header); pinnedVideoPlayer.appendChild(body); makeDraggable(pinnedVideoPlayer, header); const createAndAppendVideo = (src, aspectRatio = "16 / 9") => { const video = document.createElement('video'); video.src = src; video.controls = true; video.autoplay = true; video.muted = true; video.style.aspectRatio = aspectRatio; video.setAttribute('playsinline', ''); body.appendChild(video); return video; }; if (data.type === 'youtube') { body.innerHTML = `<iframe src="https://www.youtube.com/embed/${data.id}?autoplay=1&mute=1" allow="autoplay; encrypted-media" allowfullscreen style="aspect-ratio: 16 / 9;"></iframe>`; } else if (data.type === 'm3u' || data.type === 'direct') { createAndAppendVideo(data.url); } else if (data.type === 'twitter') { try { const response = await fetch(`https://api.vxtwitter.com/i/status/${data.id}`); const tweetData = await response.json(); const mediaItems = tweetData.media_extended; if (mediaItems && mediaItems.length > 0) { const playMedia = (mediaItem, clickedButton) => { body.innerHTML = ''; const aspectRatio = mediaItem.width / mediaItem.height; createAndAppendVideo(mediaItem.url, aspectRatio); if (selectorContainer) { selectorContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active')); if (clickedButton) clickedButton.classList.add('active'); } }; let selectorContainer; if (mediaItems.length > 1) { selectorContainer = document.createElement('div'); selectorContainer.className = 'video-selector'; mediaItems.forEach((item, index) => { const button = document.createElement('button'); button.innerText = `Ø§Ù„Ù…Ù‚Ø·Ø¹ ${index + 1}`; button.onclick = () => playMedia(item, button); selectorContainer.appendChild(button); }); pinnedVideoPlayer.appendChild(selectorContainer); body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:white;font-size:14px;aspect-ratio:16/9;">Ø§Ø®ØªØ± Ù…Ù‚Ø·Ø¹Ø§Ù‹</div>`; } else { playMedia(mediaItems[0], null); } } else { body.innerHTML = `<p style="color:white;padding:10px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆ.</p>`; } } catch (error) { console.error("Error fetching Twitter video:", error); body.innerHTML = `<p style="color:white;padding:10px;">Ø­Ø¯Ø« Ø®Ø·Ø£.</p>`; } } showSystemMsg(`ğŸ“º Ù‚Ø§Ù… ${data.setBy} Ø¨ØªØ´ØºÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯`); } else { pinnedVideoPlayer.style.display = 'none'; } });
    }
  </script>
</body>
</html>
