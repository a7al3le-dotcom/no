<!DOCTYPE html>
<html lang="ar" hreflang="ar-sa" style="height: 100%;">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <title>Ø´Ø§Øª Ù†ÙˆÙ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    body { margin: 0; font-family: 'Tajawal', sans-serif; overflow: hidden; }
    #topButtons { position: fixed; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000; }
    .btn { padding: 6px 12px; background: white; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; font-size: 14px; }
    #usersBox, #editNameModal, #setVideoModal {
      position: fixed; top: 50%; left: 50%; transform: translate(--50%, -50%);
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1003; display: none;
    }
    #usersList { max-height: 200px; overflow-y: auto; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; }
    
    #pinnedVideoPlayer {
      position: fixed; top: 50px; left: 50px;
      width: 450px;
      background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 998;
      display: flex; /* Changed */
      flex-direction: column;
    }
    .video-header {
      background-color: #337ab7; color: white;
      padding: 5px 10px; border-top-left-radius: 7px; border-top-right-radius: 7px;
      cursor: move;
      display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0;
    }
    .video-body { 
        width: 100%; 
        background: #000; 
        /* ØªÙ… Ø¥Ø²Ø§Ù„Ø© aspect-ratio Ù…Ù† Ù‡Ù†Ø§ Ù„Ø¬Ø¹Ù„Ù‡ Ù…Ø±Ù†Ø§Ù‹ */
    }
    .video-body iframe, .video-body video { 
        width: 100%; 
        height: 100%; 
        border: none; 
        display: block;
        aspect-ratio: 16 / 9; /* ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© */
    }
    .close-pinned-video {
      background: #d9534f; border: 1px solid #d43f3a; color: white;
      border-radius: 50%; width: 22px; height: 22px;
      cursor: pointer; font-size: 14px; line-height: 20px; text-align: center;
    }
    .video-selector {
      display: flex; gap: 5px; padding: 5px; background: #e9ecef;
      border-bottom-left-radius: 7px; border-bottom-right-radius: 7px;
      flex-shrink: 0;
    }
    .video-selector button {
      flex: 1; padding: 5px; font-size: 12px; background: #fff;
      border: 1px solid #ccc; border-radius: 4px; cursor: pointer;
    }
    .video-selector button.active { background-color: #337ab7; color: white; border-color: #2e6da4; }

    #messages { overflow-y: auto; padding: 10px; padding-bottom: 70px; background: #fff; direction: rtl; font-family: 'Tajawal', sans-serif; height: 100vh; box-sizing: border-box; }
    .msg { display: flex; gap: 10px; margin: 6px 0; font-size: 15px; align-items: flex-start; }
    .sys { text-align: center; color: gray; font-size: 12px; margin: 5px 0; }
    .user { font-weight: bold; color: #3366cc; }
    .time { font-size: 11px; color: gray; flex-shrink: 0; margin-right: auto; }
    #inputArea { position: fixed; bottom: 0; left: 0; right: 0; display: flex; align-items: center; gap: 8px; border-top: 1px solid #ddd; padding: 6px; background: #fafafa; z-index: 999; }
    #messageInput { flex: 1; font-size: 16px; padding: 8px; border: 1px solid #ccc; outline: none; direction: rtl; }
    #sendBtn { padding: 8px 12px; background: #f0f0f0; border: 1px solid #ccc; cursor: pointer; }
  </style>
</head>
<body>
    <div id="topButtons">
        <div class="btn" id="setVideoBtn">ğŸ“º ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ</div>
        <div class="btn" id="onlineListBtn">ğŸ‘¥ <span id="count">0</span> Ù…ØªØµÙ„</div>
        <div class="btn" id="changeNameBtn">âœï¸ ØºÙŠØ± Ø§Ø³Ù…Ùƒ</div>
    </div>
    <div id="pinnedVideoPlayer"></div>
    <div id="setVideoModal">
        <h4>ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¬Ù…ÙŠØ¹</h4>
        <input type="text" id="videoUrlInput" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ ØªÙˆÙŠØªØ±ØŒ Ø£Ùˆ M3U"/>
        <button id="submitVideoUrlBtn">ØªØ«Ø¨ÙŠØª</button>
    </div>
    <div id="usersBox"><h4>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</h4><div id="usersList"></div></div>
    <div id="editNameModal"><label for="newNameInput">ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label><input type="text" id="newNameInput" maxlength="20" /><button id="saveNameBtn">Ø­ÙØ¸</button></div>
    <div id="overlay"></div>
    <div id="messages"></div>
    <div id="inputArea"><input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." /><button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button></div>

  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyDttyEjbuC6gzHxuN0IR8yi_9fO-aFyW64",
  authDomain: "studio-4914109762-6a41f.firebaseapp.com",
  projectId: "studio-4914109762-6a41f",
  storageBucket: "studio-4914109762-6a41f.firebasestorage.app",
  messagingSenderId: "134781295069",
  appId: "1:134781295069:web:3c020f46f8fbeaca24fe34"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const myUserRef = db.ref("online").push();
    myUserRef.onDisconnect().remove();
    let username = "Ø²Ø§Ø¦Ø±_" + Math.floor(Math.random() * 1000);
    myUserRef.set({ name: username });

    const onlineListBtn = document.getElementById("onlineListBtn");
    const changeNameBtn = document.getElementById("changeNameBtn");
    const setVideoBtn = document.getElementById("setVideoBtn");
    const usersBox = document.getElementById("usersBox");
    const usersList = document.getElementById("usersList");
    const overlay = document.getElementById("overlay");
    const count = document.getElementById("count");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const editNameModal = document.getElementById("editNameModal");
    const newNameInput = document.getElementById("newNameInput");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const setVideoModal = document.getElementById("setVideoModal");
    const videoUrlInput = document.getElementById("videoUrlInput");
    const submitVideoUrlBtn = document.getElementById("submitVideoUrlBtn");
    const pinnedVideoPlayer = document.getElementById("pinnedVideoPlayer");
    const onlineUsersCache = {}; 

    function makeDraggable(element, handle) {
        let offsetX = 0, offsetY = 0;
        let isDragging = false;
        
        handle.onmousedown = (e) => {
            e.preventDefault(); isDragging = true;
            offsetX = e.clientX - element.offsetLeft;
            offsetY = e.clientY - element.offsetTop;
            document.onmousemove = dragElement;
            document.onmouseup = stopDragging;
        };
        function dragElement(e) {
            if (isDragging) {
                element.style.left = (e.clientX - offsetX) + "px";
                element.style.top = (e.clientY - offsetY) + "px";
            }
        }
        function stopDragging() {
            isDragging = false;
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }
    
    function getYoutubeVideoId(url) {
        if (!url) return null;
        const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        return (url.match(regex) || [])[1] || null;
    }
    
    function getTweetId(url) {
        if (!url) return null;
        const regex = /(?:https?:\/\/)?(?:www\.)?(?:twitter|x)\.com\/(?:\w+)\/status\/(\d+)/;
        return (url.match(regex) || [])[1] || null;
    }

    function closeAllModals() {
        usersBox.style.display = 'none';
        editNameModal.style.display = 'none';
        setVideoModal.style.display = 'none';
        overlay.style.display = 'none';
    }

    function updateUsername(newName) {
      if (!newName || newName === username) return;
      username = newName;
      myUserRef.update({ name: newName });
    }

    function addMessage(user, text, time) {
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<span class="user">${user}: </span><span>${text}</span><span class="time">(${time})</span>`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      db.ref("messages").push().set({ user: username, text, time });
      messageInput.value = "";
    }

    function showSystemMsg(text) {
      const div = document.createElement("div");
      div.className = "sys";
      div.textContent = text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function updateUsersList() {
      db.ref("online").once("value", (snap) => {
        const usersObject = snap.val() || {};
        const users = Object.values(usersObject);
        usersList.innerHTML = "";
        users.forEach((user) => {
          const userItem = document.createElement("div");
          userItem.className = "user-item";
          userItem.textContent = user.name;
          usersList.appendChild(userItem);
        });
        count.textContent = users.length;
      });
    }

    onlineListBtn.onclick = () => { usersBox.style.display = 'block'; overlay.style.display = 'block'; };
    changeNameBtn.onclick = () => { editNameModal.style.display = 'block'; overlay.style.display = 'block'; newNameInput.value = username; newNameInput.focus(); };
    setVideoBtn.onclick = () => { setVideoModal.style.display = 'block'; overlay.style.display = 'block'; };
    overlay.onclick = closeAllModals;
    sendBtn.onclick = sendMessage;
    messageInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
    saveNameBtn.onclick = () => { const newName = newNameInput.value.trim(); if (!newName) return; updateUsername(newName); closeAllModals(); };
    
    submitVideoUrlBtn.onclick = () => {
        const url = videoUrlInput.value.trim(); if (!url) return;
        const youtubeId = getYoutubeVideoId(url);
        const tweetId = getTweetId(url);

        if (youtubeId) { db.ref("pinned_video").set({ type: 'youtube', id: youtubeId, setBy: username }); }
        else if (tweetId) { db.ref("pinned_video").set({ type: 'twitter', id: tweetId, setBy: username }); }
        else if (url.toLowerCase().includes('.m3u')) { db.ref("pinned_video").set({ type: 'm3u', url: url, setBy: username }); }
        else { alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…."); return; }
        closeAllModals();
    };

    db.ref("online").on("child_added", (snap) => {
      const user = snap.val(); const userId = snap.key;
      onlineUsersCache[userId] = user.name;
      if (userId !== myUserRef.key) { showSystemMsg(`ğŸ“¥ ${user.name} Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©`); }
      updateUsersList();
    });
    db.ref("online").on("child_removed", (snap) => {
      const userId = snap.key;
      const departedUserName = onlineUsersCache[userId] || 'Ù…Ø³ØªØ®Ø¯Ù… ØºØ§Ø¯Ø±';
      delete onlineUsersCache[userId];
      showSystemMsg(`ğŸ“¤ ${departedUserName} ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©`);
      updateUsersList();
    });
    db.ref("online").on("child_changed", (snap) => {
      const userId = snap.key; const newName = snap.val().name; const oldName = onlineUsersCache[userId];
      if (oldName !== newName) {
        showSystemMsg(`âœï¸ ${oldName} ØºÙŠØ± Ø§Ø³Ù…Ù‡ Ø¥Ù„Ù‰ ${newName}`);
        onlineUsersCache[userId] = newName;
        updateUsersList();
      }
    });
    db.ref("messages").limitToLast(50).on("child_added", (snap) => {
      const msg = snap.val();
      addMessage(msg.user, msg.text, msg.time);
    });

    db.ref("pinned_video").on("value", async (snap) => {
        const data = snap.val();
        pinnedVideoPlayer.innerHTML = '';
        if (data) {
            pinnedVideoPlayer.style.display = 'flex';
            const header = document.createElement('div');
            header.className = 'video-header';
            header.innerHTML = `<span>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</span>`;
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-pinned-video';
            closeBtn.innerHTML = 'âœ–';
            closeBtn.onclick = () => db.ref("pinned_video").remove();
            header.appendChild(closeBtn);
            const body = document.createElement('div');
            body.className = 'video-body';
            pinnedVideoPlayer.appendChild(header);
            pinnedVideoPlayer.appendChild(body);
            
            makeDraggable(pinnedVideoPlayer, header);

            if (data.type === 'youtube') {
                body.innerHTML = `<iframe src="https://www.youtube.com/embed/${data.id}?autoplay=1&mute=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            } else if (data.type === 'm3u') {
                const video = document.createElement('video');
                video.controls = true; video.autoplay = true; video.muted = true;
                body.appendChild(video);
                if (Hls.isSupported()) { const hls = new Hls(); hls.loadSource(data.url); hls.attachMedia(video); }
                else if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = data.url; }
            } else if (data.type === 'twitter') {
                try {
                    const response = await fetch(`https://api.vxtwitter.com/i/status/${data.id}`);
                    const tweetData = await response.json();
                    
                    const mediaItems = tweetData.media_extended;
                    if (mediaItems && mediaItems.length > 0) {
                        const playMedia = (mediaUrl, clickedButton) => {
                            body.innerHTML = '';
                            const video = document.createElement('video');
                            video.src = mediaUrl;
                            video.controls = true; video.autoplay = true; video.muted = true;
                            body.appendChild(video);
                            if (selectorContainer) {
                                selectorContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                                if (clickedButton) clickedButton.classList.add('active');
                            }
                        };

                        let selectorContainer;
                        if (mediaItems.length > 1) {
                            selectorContainer = document.createElement('div');
                            selectorContainer.className = 'video-selector';
                            mediaItems.forEach((item, index) => {
                                const button = document.createElement('button');
                                button.innerText = `Ø§Ù„Ù…Ù‚Ø·Ø¹ ${index + 1}`;
                                button.onclick = () => playMedia(item.url, button);
                                selectorContainer.appendChild(button);
                            });
                            pinnedVideoPlayer.appendChild(selectorContainer);
                            // Ù„Ø§ ØªÙ‚Ù… Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø§ØªØ±Ùƒ Ø§Ù„Ø®ÙŠØ§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                            body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:white;font-size:14px;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‚Ø·Ø¹ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„</div>`;
                        } else {
                            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù‚Ø·Ø¹Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ ÙÙ‚Ø·ØŒ Ø´ØºÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            playMedia(mediaItems[0].url, null);
                        }
                    } else {
                        body.innerHTML = `<p style="color:white;padding:10px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØªØºØ±ÙŠØ¯Ø©.</p>`;
                    }
                } catch (error) {
                    console.error("Failed to fetch Twitter video:", error);
                    body.innerHTML = `<p style="color:white;padding:10px;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.</p>`;
                }
            }
            showSystemMsg(`ğŸ“º Ù‚Ø§Ù… ${data.setBy} Ø¨ØªØ´ØºÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯`);
        } else {
            pinnedVideoPlayer.style.display = 'none';
        }
    });
  </script>
</body>
</html>
